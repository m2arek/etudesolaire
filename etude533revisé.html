<!doctype html>
<html lang="fr">
<head>
 <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script> 
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dimensionnement PV ‚Äî Carto & PVGIS + Simulateur HP/HC (A/B/C) + PV + Batterie</title>

  <!-- Leaflet + Draw CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

  <style>
  :root{--bg:#0b0f14;--card:#121821;--muted:#8ea0b4;--text:#e6eef6;--accent:#3da5ff;--ok:#30d158;--warn:#ffb020;--border:#1e2937}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  h1{margin:0 0 8px;font-size:clamp(1.25rem,2.4vw,1.6rem)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);margin-bottom:14px}
  label{font-size:.85rem;color:var(--muted);display:block;margin-bottom:6px}
  input[type="number"],input[readonly],input[type="text"]{width:100%;background:#0e141b;color:var(--text);border:1px solid #263241;border-radius:12px;padding:10px 12px;font-size:.95rem}
  input[type="number"]:focus,input[type="text"]:focus{outline:2px solid var(--accent);border-color:transparent}
  .small{font-size:.85rem;color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grid2{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:12px}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .pill{background:#0e141b;border:1px solid #1f2a38;padding:10px 14px;border-radius:12px}
  .pill strong{color:var(--ok)}
  .grid{overflow:auto;border-radius:12px;border:1px solid var(--border)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap}
  th{position:sticky;top:0;background:#0f151d;z-index:1}
  tfoot td{font-weight:700}
  .chart{background:#0e141b;border:1px solid #1f2a38;border-radius:12px;padding:12px}
  .note{font-size:.9rem;color:var(--muted)}
  .readonly{background:#0b1218;color:#a5b6c8}
  .hidden{display:none!important}
  .tabs{display:flex;gap:8px;margin:10px 0}
  .tab-btn{padding:10px 14px;border-radius:10px;border:1px solid #1e2937;background:#0e141b;color:#cfe1f1;cursor:pointer}
  .tab-btn.active{background:var(--accent);color:#031f34;border-color:transparent}
  .tab-panel{display:none}
  .tab-panel.active{display:block}

  .toolbar{position:sticky;top:0;background:#0e141b;border:1px solid #1f2a38;border-radius:12px;padding:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .toolbar input[type="text"]{width:360px}
  #map{height:500px;border:1px solid #1f2a38;border-radius:12px}
  .leaflet-container a{color:#9cc9ff}
  .badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:.75rem;font-weight:700;border:1px solid #21613a;background:#123d22;color:#92ffba}
  .warn{border-color:#5f3a07;background:#2a1a05;color:#ffce7a}

  #billCompareCard{max-width:1100px;margin-left:auto;margin-right:auto;}
  #billCompareCard .chart svg{display:block;width:100%}
  #billCompareCard .chart{padding:12px}

  /* Th√®me clair */
  body.theme-light{
    --bg:#ffffff;--card:#ffffff;--text:#0b0f14;--muted:#475569;--border:#e5e7eb;
  }
 body.theme-light input[type="number"],body.theme-light input[readonly],body.theme-light input[type="text"], body.theme-light select {background:#ffffff;color:var(--text);border:1px solid var(--border)}
  body.theme-light .readonly{background:#f1f5f9;color:#475569}
  body.theme-light .card{background:var(--card);border-color:var(--border)}
  body.theme-light .toolbar{background:#f8fafc;border-color:var(--border)}
  body.theme-light #map{border-color:var(--border)}
  body.theme-light .grid{border-color:var(--border)}
  body.theme-light th{background:#f8fafc}
  body.theme-light .chart{background:#ffffff;border:1px solid var(--border)}
  body.theme-light .pill{background:#ffffff;border:1px solid var(--border)}
  body.theme-light .badge{border-color:#16a34a;background:#dcfce7;color:#166534}
  body.theme-light .warn{border-color:#f59e0b;background:#fffbeb;color:#b45309}
  body.theme-light .leaflet-container a{color:#0ea5e9}

  /* Th√®me clair beige (optionnel) */
  body.theme-light{
    --bg:#f7f2e7;--card:#fffaf0;--text:#121417;--muted:#6b7177;--accent:#1f6feb;--ok:#198754;--warn:#7a4a00;--border:#e5dcc8;
  }
  body.theme-light .card,body.theme-light .toolbar,body.theme-light .chart{background:var(--card);border-color:var(--border)}
  body.theme-light .tab-btn{background:#ffffff;color:var(--text);border-color:var(--border)}
  body.theme-light .tab-btn.active{background:var(--accent);color:#ffffff;border-color:transparent}
  body.theme-light .grid{border-color:var(--border)}
  body.theme-light th{background:#f2ecdd;color:var(--text);border-bottom-color:var(--border)}
  body.theme-light .badge{background:#e8f7ed;border-color:#a8ddb5;color:#1c7c3d}
  body.theme-light .warn{border-color:#f2c389;background:#fff1de;color:#7a4a00}
  body.theme-light input[type="number"],body.theme-light input[readonly],body.theme-light input[type="text"]{background:#ffffff;color:var(--text);border:1px solid var(--border)}
  body.theme-light input[type="number"]:focus,body.theme-light input[type="text"]:focus{outline:2px solid var(--accent);border-color:transparent}
  body.theme-light .readonly{background:#f3efe2;color:#4b5563}
  body.theme-light .leaflet-container a{color:#0b63ce}

  .theme-toggle{position: fixed;top: 12px;right: 12px;z-index: 9999;}
  .theme-toggle button{padding: 8px 12px;border-radius: 999px;border: 1px solid var(--border);background: var(--card);color: var(--text);cursor: pointer;font-size: 0.9rem;}
  
  /* Correction pour la lisibilit√© des √©tiquettes de donn√©es dans les graphiques en mode clair */
  body.theme-light .chart svg text {
    fill: var(--text) !important; 
    stroke: none !important;
    font-weight: bold !important; /* Ajoute le gras */      
  }
  </style>
</head>

<button onclick="remplirEtTelechargerRapportPDF()">
    G√©n√©rer le Rapport PDF
</button>


  
<body class="theme-light">
  <div class="theme-toggle">
    <button id="themeToggleBtn" type="button" aria-label="Basculer le th√®me">‚òÄÔ∏è Clair</button>
  </div>

  <div class="wrap">
    <h1>Dimensionnement PV ‚Äî int√©gr√© cartographie & PVGIS</h1>
    <div class="note">
      Onglet 0 : cartographier le toit, mesurer la surface, orienter, et r√©cup√©rer le productible PVGIS (1 kWc).
      Les donn√©es alimentent automatiquement le simulateur.
      <b>Tarif de rachat</b> & <b>Prime</b> sont <u>auto-d√©duits du code postal</u> (territoire).
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="tab0">0) Carto & PVGIS</button>
      <button class="tab-btn" data-tab="tab1">1) Donn√©es & profils</button>
      <button class="tab-btn" data-tab="tab2">2) Dimensionnement & r√©sultats</button>
      <button class="tab-btn" data-tab="tab3">3) PV + Batterie</button>
    </div>

    <!-- ======== TAB 0 : CARTO & PVGIS ======== -->
    <div id="tab0" class="tab-panel active">
      <div class="card">
        <div class="row" style="margin-bottom:12px;gap:12px">
          <div style="min-width:220px;flex:1">
            <label>Nom</label>
            <input id="clientName" type="text" placeholder="Nom du client">
          </div>
        </div>

        <div class="toolbar">
          <input id="address" type="text" placeholder="Adresse (ex : 10 rue..., ville, code postal)" />
          <button id="searchBtn">Rechercher</button>
          <button id="toggleDraw">Mesurer / Tracer</button>
          <button id="calcPV">Calculer productible (1 kWc)</button>
        </div>
        <div id="map"></div>

        <div class="row" style="margin-top:12px;gap:12px">
          <div style="min-width:220px;flex:1"><label>Latitude</label><input id="lat" type="text" readonly></div>
          <div style="min-width:220px;flex:1"><label>Longitude</label><input id="lng" type="text" readonly></div>
          <div style="min-width:220px;flex:1"><label>Orientation (azimut ¬∞) <span class="small">(0 = Sud, Est = -90, Ouest = +90)</span></label><input id="azimut" type="text" readonly></div>
          <div style="min-width:220px;flex:1"><label>Inclinaison (¬∞)</label><input id="tilt" type="number" value="35"></div>
          <div style="min-width:220px;flex:1"><label>Surface toiture mesur√©e (m¬≤)</label><input id="area" type="text" readonly></div>
          <div style="min-width:220px;flex:1"><label>Productible annuel (kWh/kWc/an)</label><input id="productible" type="text" readonly></div>
        </div>

        <div class="row" style="margin-top:12px;gap:12px">
          <div style="min-width:220px;flex:1"><label>Code postal (d√©tect√©)</label><input id="cp" type="text" readonly></div>
          <div style="min-width:220px;flex:2"><label>Territoire</label><input id="territoire" type="text" readonly value="France Metropolitaine"></div>
          <div class="small" style="align-self:flex-end">
            <span class="badge">Auto</span> Le territoire pilote le <b>Tarif de rachat</b> et la <b>Prime</b> dans l‚Äôonglet 2/3 (en fonction de la puissance kWc).
          </div>
        </div>

        <div class="row" style="margin-top:12px;gap:12px">
          <div style="min-width:220px;flex:1"><label>Surface toiture (m¬≤)</label><input id="roof" type="number" step="1" readonly></div>
          <div style="min-width:220px;flex:1"><label>Puissance module (Wc)</label><input id="wp" type="number" step="1" value="500"></div>
          <div style="min-width:220px;flex:1"><label>Pmax toiture (kWc)</label><input id="pmaxOut" type="text" readonly></div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">PVGIS ‚Äî Production mensuelle (1 kWc)</h3>
        <div class="grid">
          <table id="monthly"><thead><tr><th>Mois</th><th>Production (kWh) pour 1 kWc</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="small" style="margin-top:8px">Ces valeurs remplacent le profil interne <code>P1</code> du simulateur. Toute la cha√Æne se met √† jour.</div>
      </div>
    </div>

    <!-- ======== TAB 1 : Donn√©es & profils ======== -->
    <div id="tab1" class="tab-panel">
      <div class="card">
        <div class="row" style="gap:12px;flex-wrap:wrap">
          <label class="pill"><input type="radio" name="mode" value="A" checked> &nbsp;<b>Mode A</b> ‚Äî HP/HC complets</label>
          <label class="pill"><input type="radio" name="mode" value="B"> &nbsp;<b>Mode B</b> ‚Äî Total kWh (Ratio)</label>
          <label class="pill"><input type="radio" name="mode" value="C"> &nbsp;<b>Mode C</b> ‚Äî Je n‚Äôai que la facture (‚Ç¨)</label>
        </div>

        <div class="row" id="installTariffs" style="gap:12px;flex-wrap:wrap;margin-top:6px">
          <label class="pill"><input type="radio" name="capexTariff" value="2150" checked>&nbsp;<b>Tarif 1</b> ‚Äî 2150 ‚Ç¨/kWc</label>
          <label class="pill"><input type="radio" name="capexTariff" value="1800">&nbsp;<b>Tarif 2</b> ‚Äî 1800 ‚Ç¨/kWc</label>
          <label class="pill"><input type="radio" name="capexTariff" value="1400">&nbsp;<b>Tarif 3</b> ‚Äî 1400 ‚Ç¨/kWc</label>
        </div>

        <div id="alerts1" class="small" style="margin-top:8px"></div>
      </div>

      <div class="card">
  <div class="row" style="gap:12px;align-items:center;flex-wrap:wrap">
    <label>Config pr√©-d√©finie (kit)</label>

    <select id="kitPower" style="min-width:140px;padding:10px;border-radius:10px;border:1px solid var(--border);">
      <option value="">Puissance‚Ä¶</option>
    </select>

    <select id="kitPhase" style="min-width:140px;padding:10px;border-radius:10px;border:1px solid var(--border);">
      <option value="">Phase‚Ä¶</option>
    </select>

    <select id="kitBatt" style="min-width:160px;padding:10px;border-radius:10px;border:1px solid var(--border);">
      <option value="">Batterie‚Ä¶</option>
    </select>

    <label class="pill" style="margin-left:6px">
      <input type="checkbox" id="lockKit"> &nbsp;Verrouiller puissance & prix (config fig√©e)
    </label>
    <span class="small">Quand verrouill√© : P au croisement d√©sactiv√©, P/‚Ç¨ gel√©s.</span>
<input id="discountR" type="number" step="1" value="0"
       placeholder="R (remise ‚Ç¨)"
       style="min-width:140px;padding:10px;border-radius:10px;border:1px solid var(--border);">

<input id="kitPriceNet" type="text" readonly
       placeholder="Prix installation (net ‚Ç¨)"
       class="readonly"
       style="min-width:180px;padding:10px;border-radius:10px;border:1px solid var(--border);">

    <div id="kitMsg" class="small" style="margin-top:6px;color:#b45309"></div>
  </div>
</div>


      <div class="card">
        <div class="grid2">
          <div data-show="A B C"><label for="buyHP">Tarif HP (‚Ç¨/kWh)</label><input id="buyHP" type="number" step="0.0001" value="0.18"></div>
          <div data-show="A B C"><label for="buyHC">Tarif HC (‚Ç¨/kWh)</label><input id="buyHC" type="number" step="0.0001" value="0.13"></div>
          <div data-show="B C"><label for="buy">Co√ªt kWh achet√© GLOBAL (‚Ç¨/kWh)</label><input id="buy" type="number" step="0.0001" value="0.07"></div>
          <div data-show="B C"><label for="ratio">Ratio HP (%)</label><input id="ratio" type="number" step="1" value="70"></div>
          <div data-show="C"><label for="avgBill">Facture mensuelle moyenne (‚Ç¨)</label><input id="avgBill" type="number" step="0.01" value="0"></div>
          <div data-show="A B C"><label for="inc">Hausse √©lec /an (%)</label><input id="inc" type="number" step="0.1" value="5"></div>
          <div data-show="A B C"><label for="years">Dur√©e (ans)</label><input id="years" type="number" step="1" value="20"></div>
        </div>

        <div id="subC" class="row hidden" style="margin-top:10px">
          <label class="pill"><input type="radio" name="cBillMode" value="avg" checked> &nbsp;Facture moyenne (copi√©e 12√ó)</label>
          <label class="pill"><input type="radio" name="cBillMode" value="monthly"> &nbsp;Facture mensuelle (colonne ‚Ç¨)</label>
        </div>
      </div>

      <div class="card">
        <div class="small" id="modesHelp">
          <span id="helpA">Mode A : √©ditez <b>HP</b> et <b>HC</b>. Total est calcul√© automatiquement.</span>
          <span id="helpB" class="hidden">Mode B : √©ditez <b>Total</b>. HP/HC ventil√©s au <b>Ratio HP</b>.</span>
          <span id="helpC" class="hidden">Mode C : saisissez la <b>facture</b> (moyenne ou mensuelle). Conversion via tarif Global ou HP/HC+Ratio.</span>
        </div>
        <div class="grid">
          <table id="inputsTbl">
            <thead>
              <tr>
                <th>Mois</th><th>HP (kWh)</th><th>HC (kWh)</th><th>Total (kWh)</th><th>Facture (‚Ç¨)</th><th>Source</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td>Total</td>
                <td id="HPsum">‚Äî</td>
                <td id="HCsum">‚Äî</td>
                <td id="TOTsum">‚Äî</td>
                <td id="BILLsum">‚Äî</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
    <!-- ======== TAB 2 : R√©sultats PV seul ======== -->
    <div id="tab2" class="tab-panel">
      <div class="row" style="margin-top:12px">
        <button id="saveData">Sauvegarder les donn√©es</button>
        <button id="loadButton">Charger un fichier</button>
        <input id="loadData" type="file" accept=".json" style="display:none">
      </div>

      <div class="card">
        <div class="grid2">
          <div><label for="wp2">Puissance module (Wc)</label><input id="wp2" type="number" step="1" value="500"></div>
          <div><label for="pwr">Puissance install√©e (kWc)</label><input id="pwr" type="number" step="1" value="1"></div>
          <div><label for="crossOut">P au croisement (kWc)</label><input id="crossOut" type="text" readonly value="‚Äî" title="Double-clic pour r√©activer l‚Äôauto-application"></div>
          <div><label for="sell">Tarif rachat (‚Ç¨/kWh) <span class="small" id="sellAutoFlag"></span></label><input id="sell" type="number" step="0.0001" value="0.0761"></div>
          <div><label for="prime">Prime (‚Ç¨) <span class="small" id="primeAutoFlag"></span></label><input id="prime" type="number" step="1" value="0"></div>
        </div>
        <div class="small" id="territoryInfo" style="margin-top:8px;color:#9bb0c6"></div>
      </div>

      <div class="card">
        <div class="kpi">
          <div class="pill">Taux d'autonomie : <strong id="k_aut"></strong></div>
          <div class="pill">Taux d'autoconsommation : <strong id="k_sc"></strong></div>
          <div class="pill">Taux de revente : <strong id="k_rev"></strong></div>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="pill"> √©cos + revente <span id="k_yearsA"></span> ans : <strong id="k_totAll"></strong></div>
          <div class="pill"> √©cos elec <span id="k_yearsB"></span> ans : <strong id="k_totSave"></strong></div>
          <div class="pill"> revente  <span id="k_yearsC"></span> ans : <strong id="k_totSell"></strong></div>
          <div class="pill">√âcos moyenne Mensuel <span id="k_yearsD"></span> ans : <strong id="k_avgMonth"></strong></div>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="pill">Co√ªt installation : <strong id="k_capex"></strong></div>
          <div class="pill">Prime : <strong id="k_prime"></strong></div>
          <div class="pill">Co√ªt r√©el : <strong id="k_costreal"></strong></div>
          <div class="pill">ROI (payback) : <strong id="k_roi"></strong></div>
        </div>
      </div>

      <div class="card" id="chartCard">
        <h3 style="margin:0 0 8px">Graphique d'aide au dimensionnement</h3>
        <div class="small">Courbes 1 kWc ‚Üí Pmax : <span style="color:#3da5ff">Autonomie %</span>, <span style="color:#30d158">Autoconsommation %</span>, <span style="color:#ffb020">Revente %</span>.</div>
        <div class="chart"><svg id="chart" width="100%" height="280" role="img" aria-label="Autonomie/Autoconsommation/Revente vs Puissance"></svg></div>
      </div>

      <div id="results" class="tables" hidden>
        <div class="card">
          <h3 style="margin:0 0 8px">D√©tail mensuel ‚Äì Ann√©e 1 (prix de base)</h3>
          <div class="grid">
            <table id="monthTbl">
              <thead>
                <tr>
                  <th>Mois</th>
                  <th>Consommation</th>
                  <th>Production</th>
                  <th>√âco kWh (HP)</th>
                  <th>Revente kWh</th>
                  <th>Achat r√©seau</th>
                  <th>√âconomies (‚Ç¨)</th>
                  <th>Revente (‚Ç¨)</th>
                  <th>√âco totale (‚Ç¨)</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td>Total</td>
                  <td id="t_C">‚Äî</td>
                  <td id="t_P">‚Äî</td>
                  <td id="t_Ekwh">‚Äî</td>
                  <td id="t_Rkwh">‚Äî</td>
                  <td id="t_Buy">‚Äî</td>
                  <td id="t_Save">‚Äî</td>
                  <td id="t_Sell">‚Äî</td>
                  <td id="t_Etot">‚Äî</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px">Tableau annuel ‚Äì √âconomies & Cumul</h3>
          <div class="grid">
            <table id="yearTbl">
              <thead><tr><th>an</th><th>√âconomie totale (‚Ç¨)</th><th>Cumul (‚Ç¨)</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card tests">
          <h3 style="margin:0 0 8px">Tests int√©gr√©s</h3>
          <div class="grid">
            <table id="testsTbl"><thead><tr><th>Test</th><th>Attendu</th><th>Re√ßu</th><th>R√©sultat</th></tr></thead><tbody></tbody></table>
          </div>
          <div class="small">V√©rifie : (1) 12 mois, (2) HP+HC‚âàTOT, (3) Pmax(100m¬≤,500Wc)=25 kWc, (4) Facture Mode A coh√©rente.</div>
        </div>

        <div class="card" id="billChartCard">
          <h3 style="margin:0 0 8px">√âvolution du co√ªt de vos factures d‚Äô√©lectricit√© (20 ans)</h3>
          <div class="small">Sans PV, avec hausse annuelle de <span id="billIncPct"></span>.</div>
          <div class="chart">
            <svg id="billChart" width="100%" height="320" role="img" aria-label="√âvolution du co√ªt des factures (20 ans)"></svg>
          </div>
        </div>

        <div class="card" id="billCompareCard">
          <h3 style="margin:0 0 8px">√âvolution de vos factures avec ou sans PV (20 ans)</h3>
          <div class="chart">
            <svg id="billCompareChart" width="100%" height="360" role="img" aria-label="Factures sans et avec PV sur 20 ans"></svg>
          </div>
          <div class="small">La barre verte = facture sans PV ‚àí (√©conomies + revente + prime en ann√©e 2). Elle peut √™tre n√©gative.</div>
        </div>
      </div>
    </div>

    <!-- ======== TAB 3 : PV + Batterie ======== -->
   <div id="tab3" class="tab-panel">
  <div class="card">
    <div class="grid2">
      <div><label for="pwrB">Puissance install√©e (kWc) </label><input id="pwrB" type="number" step="1" value="1"></div>
      <div><label for="crossOutB">P au croisement (kWc)</label><input id="crossOutB" type="text" readonly value="‚Äî" title="Double-clic pour r√©activer l‚Äôauto-application"></div>
      <div><label for="battKWh">Capacit√© batterie (kWh)</label><input id="battKWh" type="number" step="0.1" value="5"></div>
      <div><label for="battPrice">Prix batterie (‚Ç¨/kWh)</label><input id="battPrice" type="number" step="1" value="400"></div>
    </div>
    <div class="small" style="margin-top:6px">
      L‚Äôonglet batterie calcule son propre <b>P au croisement</b> (autonomie = autoconsommation) et peut auto-appliquer la puissance optimale ind√©pendamment de l‚Äôonglet 2.
      Les tarifs & primes restent partag√©s mais sont <b>auto-d√©duits sur la puissance de l‚Äôonglet actif</b>.
    </div>
  </div>

  <div class="card">
    <div class="kpi">
      <div class="pill">Taux d'autonomie : <strong id="k_autB"></strong></div>
      <div class="pill">Taux d'autoconsommation : <strong id="k_scB"></strong></div>
      <div class="pill">Taux de revente : <strong id="k_revB"></strong></div>
    </div>
    <div class="kpi" style="margin-top:8px">
      <div class="pill">Total (√©co + revente sur <span id="k_yearsB_A"></span> ans) : <strong id="k_totAllB"></strong></div>
      <div class="pill">Total √©conomies (sur <span id="k_yearsB_B"></span> ans) : <strong id="k_totSaveB"></strong></div>
      <div class="pill">Total revente (sur <span id="k_yearsB_C"></span> ans) : <strong id="k_totSellB"></strong></div>
      <div class="pill">√âcos moyenne /mois : <strong id="k_avgMonthlyB"></strong></div>
    </div>
    <div class="kpi" style="margin-top:8px">
      <div class="pill">Co√ªt installation PV + batt : <strong id="k_capexB"></strong></div>
      <div class="pill">Prime (PV) : <strong id="k_primeB"></strong></div>
      <div class="pill">Co√ªt r√©el : <strong id="k_costrealB"></strong></div>
      <div class="pill">ROI (payback) : <strong id="k_roiB"></strong></div>
    </div>
  </div>

  <div class="card" id="chartCardB">
    <h3 style="margin:0 0 8px">Graphique d'aide au dimensionnement (PV + batterie)</h3>
    <div class="small">Courbes 1 kWc ‚Üí Pmax (batterie fixe) : <span style="color:#3da5ff">Autonomie %</span>, <span style="color:#30d158">Autoconsommation %</span>, <span style="color:#ffb020">Revente %</span>.</div>
    <div class="chart"><svg id="chartB" width="100%" height="280" role="img" aria-label="Autonomie/Autoconsommation/Revente vs Puissance (batterie)"></svg></div>
  </div>

  <!-- R√©sultats + LES 2 GRAPHIQUES "20 ans" D√âPLAC√âS ICI EN BAS -->
  <div id="resultsB" class="tables" hidden>
    <div class="card">
      <h3 style="margin:0 0 8px">D√©tail mensuel ‚Äì Ann√©e 1 (PV + batterie)</h3>
      <div class="small" style="margin-bottom:6px;color:#9bb0c6">‚Äú√âconomies kWh‚Äù = autoconsommation directe (HP) + couverture HC via batterie.</div>
      <div class="grid">
        <table id="monthTblB">
          <thead>
            <tr>
              <th>Mois</th>
              <th>Consommation</th>
              <th>Production</th>
              <th>√âconomies kWh</th>
              <th>Revente kWh</th>
              <th>Achat r√©seau</th>
              <th>√âconomies (‚Ç¨)</th>
              <th>Revente (‚Ç¨)</th>
              <th>√âconomie totale (‚Ç¨)</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td>Total</td>
              <td id="t_C_B">‚Äî</td>
              <td id="t_P_B">‚Äî</td>
              <td id="t_Ekwh_B">‚Äî</td>
              <td id="t_Rkwh_B">‚Äî</td>
              <td id="t_Buy_B">‚Äî</td>
              <td id="t_Save_B">‚Äî</td>
              <td id="t_Sell_B">‚Äî</td>
              <td id="t_Etot_B">‚Äî</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Tableau annuel ‚Äì √âconomies & Cumul (PV + batterie)</h3>
      <div class="grid">
        <table id="yearTblB">
          <thead><tr><th>an</th><th>√âconomie totale (‚Ç¨)</th><th>Cumul (‚Ç¨)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card tests">
      <h3 style="margin:0 0 8px">Tests int√©gr√©s (PV + batterie)</h3>
      <div class="grid">
        <table id="testsTblB"><thead><tr><th>Test</th><th>Attendu</th><th>Re√ßu</th><th>R√©sultat</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="small">V√©rifie : 12 mois, coh√©rence des sommes, Pmax (100m¬≤, 500Wc)=25 kWc.</div>
    </div>

    <!-- ‚Üì‚Üì‚Üì Cartes ‚Äú20 ans‚Äù d√©plac√©es ici, √† la fin ‚Üì‚Üì‚Üì -->
    <div class="card" id="billChartCardB">
      <h3 style="margin:0 0 8px">√âvolution du co√ªt de vos factures d‚Äô√©lectricit√© (20 ans)</h3>
      <div class="small">Sans PV, avec hausse annuelle de <span id="billIncPctB"></span>.</div>
      <div class="chart">
        <svg id="billChartB" width="100%" height="320" role="img" aria-label="√âvolution du co√ªt des factures (20 ans) ‚Äî PV + batterie"></svg>
      </div>
    </div>

    <div class="card" id="billCompareCardB">
      <h3 style="margin:0 0 8px">√âvolution de vos factures avec ou sans PV (20 ans) ‚Äî PV + batterie</h3>
      <div class="chart">
        <svg id="billCompareChartB" width="100%" height="360" role="img" aria-label="Factures sans et avec PV (PV + batterie) sur 20 ans"></svg>
      </div>
      <div class="small">La barre verte = facture sans PV ‚àí (√©conomies + revente + prime en ann√©e 2). Elle peut √™tre n√©gative.</div>
    </div>
    <!-- ‚Üë‚Üë‚Üë Fin des cartes ‚Äú20 ans‚Äù ‚Üë‚Üë‚Üë -->
  </div>
</div>


  <!-- Leaflet + Draw + GeometryUtil JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet-geometryutil@0.9.3/dist/leaflet.geometryutil.min.js"></script>

  <script>
  (function(){
    const KEY='theme', body=document.body, btn=document.getElementById('themeToggleBtn');
    function setTheme(t){ t==='light'?body.classList.add('theme-light'):body.classList.remove('theme-light'); localStorage.setItem(KEY,t); if(btn) btn.textContent=t==='light'?'üåô Sombre':'‚òÄÔ∏è Clair'; }
    const saved=localStorage.getItem(KEY);
    const initial=saved?saved:(window.matchMedia&&window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark');
    setTheme(initial);
    if(btn){ btn.addEventListener('click',()=>setTheme(body.classList.contains('theme-light')?'dark':'light')); }
  })();
  </script>

  <script>
  (function(){
  'use strict';

  /* ===== options simulateur ===== */
  // ----- mode kits fig√©s -----
  var KIT_MODE = false; // true = un kit est appliqu√© et/ou verrouill√©
  var USE_CROSS_AS_PWR = true;   // onglet 2 : auto-appliquer P(croisement)
  var USE_CROSS_AS_PWR_B = true; // onglet 3 : auto-appliquer P(croisement) avec batterie
  var userPwrOverride = false;   // si l‚Äôutilisateur modifie pwr (onglet 2)
  var userPwrOverrideB = false;  // si l‚Äôutilisateur modifie pwrB (onglet 3)
  var userSellOverride = false;  // si l‚Äôutilisateur modifie sell
  var userPrimeOverride = false; // si l‚Äôutilisateur modifie prime

  /* ===== formatters ===== */
  var FR0=new Intl.NumberFormat('fr-FR',{maximumFractionDigits:0});
  var EUR0=new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0});
  var EUR2=new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:2});
  var MONTHS=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sep','Oct','Nov','D√©c'];

  /* ===== donn√©es par d√©faut ===== */
  var defaultsCTot=[7073,6368,5587,4445,2816,2292,2782,1975,3015,4383,5260,4702];
  var defaultsP1=[37,56,95,125,131,129,130,120,106,75,44,34]; // remplac√© par PVGIS si dispo
  window.P1=defaultsP1.slice();
// --- Configs pr√©-d√©finies (kits) ---
const PRESET_KITS = {
  currency: "EUR",
  configs: [
    { phase:"monophas√©", power_kwc:3, battery_kwh:null, total_eur: 9900,  price_pv_eur: 9900,  price_batt_eur: 0 },

    { phase:"monophas√©", power_kwc:6, battery_kwh:null, total_eur:14900, price_pv_eur:14900, price_batt_eur:0 },
    { phase:"triphas√©",  power_kwc:6, battery_kwh:null, total_eur:15900, price_pv_eur:15900, price_batt_eur:0 },

    { phase:"monophas√©", power_kwc:6, battery_kwh:5,  total_eur:19900, price_pv_eur:14900, price_batt_eur: 5000 },
    { phase:"triphas√©",  power_kwc:6, battery_kwh:5,  total_eur:20900, price_pv_eur:15900, price_batt_eur: 5000 },
    { phase:"monophas√©", power_kwc:6, battery_kwh:11, total_eur:23900, price_pv_eur:14900, price_batt_eur: 9000 },
    { phase:"triphas√©",  power_kwc:6, battery_kwh:11, total_eur:24900, price_pv_eur:15900, price_batt_eur: 9000 },

    { phase:"monophas√©", power_kwc:9, battery_kwh:null, total_eur:19900, price_pv_eur:19900, price_batt_eur:0 },
    { phase:"triphas√©",  power_kwc:9, battery_kwh:null, total_eur:20900, price_pv_eur:20900, price_batt_eur:0 },

    { phase:"monophas√©", power_kwc:9, battery_kwh:5,  total_eur:24900, price_pv_eur:19900, price_batt_eur: 5000 },
    { phase:"triphas√©",  power_kwc:9, battery_kwh:5,  total_eur:25900, price_pv_eur:20900, price_batt_eur: 5000 },
    { phase:"monophas√©", power_kwc:9, battery_kwh:11, total_eur:27900, price_pv_eur:19900, price_batt_eur: 8000 },
    { phase:"triphas√©",  power_kwc:9, battery_kwh:11, total_eur:28900, price_pv_eur:20900, price_batt_eur: 8000 }
  ]
};
/* ===== KITS : 3 s√©lecteurs (Puissance / Phase / Batterie) ===== */

// Remplit les 3 listes √† partir de PRESET_KITS
function populateKitSelectors(){
  function uniq(a){ return [...new Set(a)]; }
  function fill(id, arr, formatter){
    const el = document.getElementById(id); if(!el) return;
    while(el.options.length > 1) el.remove(1); // garde "‚Ä¶"
    arr.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = String(v);
      opt.textContent = formatter ? formatter(v) : String(v);
      el.appendChild(opt);
    });
  }

  const powers = uniq(PRESET_KITS.configs.map(c=>c.power_kwc)).sort((a,b)=>a-b);   // [3,6,9]
  const phases = uniq(PRESET_KITS.configs.map(c=>c.phase));                        // ["monophas√©","triphas√©"]
  const battSetRaw = uniq(PRESET_KITS.configs.map(c => (c.battery_kwh==null?'none':c.battery_kwh)));
  const battVals = ['none', ...battSetRaw.filter(v=>v!=='none').sort((a,b)=>Number(a)-Number(b))];

  fill('kitPower', powers, v => v+' kWc');
  fill('kitPhase', phases, v => v[0].toUpperCase()+v.slice(1));
  fill('kitBatt',  battVals, v => v==='none' ? 'Sans batterie' : (v+' kWh'));
}

// Retourne la config correspondant aux 3 s√©lecteurs
function getSelectedKit(){
  const pwEl = document.getElementById('kitPower');
  const phEl = document.getElementById('kitPhase');
  const btEl = document.getElementById('kitBatt');
  if(!pwEl || !phEl || !btEl) return null;

  const pw = Number(pwEl.value || 0);
  const ph = phEl.value || '';
  const btSel = btEl.value || '';
  if(!pw || !ph || !btSel) return null;

  const bkwh = (btSel==='none') ? null : Number(btSel);

  return PRESET_KITS.configs.find(c =>
    c.power_kwc===pw &&
    c.phase===ph &&
    ((c.battery_kwh ?? null) === (bkwh ?? null))
  ) || null;
}

// Applique une config trouv√©e
function applyPresetKitObj(k){
  if(!k) return;

  // Puissance (onglet 2 & 3)
  const pwrEl  = document.getElementById('pwr');
  const pwrBEl = document.getElementById('pwrB');
  if(pwrEl)  pwrEl.value  = k.power_kwc;
  if(pwrBEl) pwrBEl.value = k.power_kwc;

  // Batterie (capacit√© + ‚Ç¨/kWh)
  const battKWh = (k.battery_kwh || 0);
  const battPricePerKWh = battKWh>0 ? Math.round((k.price_batt_eur||0) / battKWh)
                                    : (Number(document.getElementById('battPrice')?.value)||400);
  const battKWhEl   = document.getElementById('battKWh');
  const battPriceEl = document.getElementById('battPrice');
  if(battKWhEl)   battKWhEl.value   = battKWh;
  if(battPriceEl) battPriceEl.value = battPricePerKWh;

  // Mode kit : fige l‚Äôoptimisation croisement
  KIT_MODE = true;
  window.USE_CROSS_AS_PWR   = false;
  window.USE_CROSS_AS_PWR_B = false;
  window.userPwrOverride    = true;
  window.userPwrOverrideB   = true;

  const co  = document.getElementById('crossOut');
  const coB = document.getElementById('crossOutB');
  if(co)  co.value  = '‚Äî (kit)';
  if(coB) coB.value = '‚Äî (kit)';

  // Tarifs/prime auto √† la puissance du kit
  applyAutoTarifEtPrime(k.power_kwc);

  // Verrouille via la case si pr√©sente
  const lock = document.getElementById('lockKit');
  if(lock){ lock.checked = true; setKitLocked(true); }
const d = document.getElementById('discountR');
if (d) d.value = '0';
refreshInstallPriceUI();

  reflectKitUI();
  scheduleRun();
}
// Calcule le prix "de base" selon l‚Äôonglet et la pr√©sence d‚Äôun kit
function _baseInstallPrice(which){
  const k = getSelectedKit();
  const capexTariff = (function(){
    const r = document.querySelector('input[name="capexTariff"]:checked');
    return r ? (Number(r.value)||0) : 2150;
  })();

  if (which === 'PV') {
    if (k) {
      // PV seul = prix PV du kit (fallback total si PV absent)
      return Number(k.price_pv_eur ?? k.total_eur ?? 0);
    } else {
      const pwr = Number(document.getElementById('pwr')?.value || 0);
      return pwr * capexTariff;
    }
  } else { // 'BATT' = PV + batterie
    if (k) {
      // total du kit si dispo, sinon PV + batt
      const pv   = Number(k.price_pv_eur || 0);
      const batt = Number(k.price_batt_eur || 0);
      return Number(k.total_eur ?? (pv + batt));
    } else {
      const pwr      = Number(document.getElementById('pwrB')?.value || 0);
      const battKWh  = Number(document.getElementById('battKWh')?.value || 0);
      const battPricePerKWh = Number(document.getElementById('battPrice')?.value || 0);
      return pwr * capexTariff + battKWh * battPricePerKWh;
    }
  }
}

// Prix installation net pour l‚Äôonglet demand√© (base - remise, ‚â•0)
function getEffectiveInstallPrice(which){
  const base = _baseInstallPrice(which);
  const rem  = Number(document.getElementById('discountR')?.value || 0);
  return Math.max(0, base - rem);
}

// Met √† jour le champ affich√© "Prix installation (net)" selon l‚Äôonglet actif
function refreshInstallPriceUI(){
  const activeTab = document.querySelector('.tab-btn.active')?.dataset.tab || 'tab2';

  // Si une batterie est s√©lectionn√©e dans le s√©lecteur de kit, on force le calcul ¬´ BATT ¬ª
  const battSel = document.getElementById('kitBatt')?.value;
  const hasBatt = (battSel && battSel !== 'none');

  const which = (activeTab === 'tab3' || hasBatt) ? 'BATT' : 'PV';

  const out = document.getElementById('kitPriceNet');
  if (out) {
    const v = getEffectiveInstallPrice(which);
    out.value = new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(v);
  }
}


// D√©sactive les radios capex quand un kit est actif
function reflectKitUI(){
  const kit = getSelectedKit();
  document.querySelectorAll('input[name="capexTariff"]').forEach(function(r){
    r.disabled = !!kit;
    if (r.parentElement) r.parentElement.style.opacity = kit ? 0.55 : 1;
  });
  const note = document.getElementById('capexNote');
  if (note) note.textContent = kit ? 'Tarif installation fix√© par le kit.' : '';
}

// √âcoute des 3 s√©lecteurs
['kitPower','kitPhase','kitBatt'].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('change', function(){
    const pw = document.getElementById('kitPower').value;
    const ph = document.getElementById('kitPhase').value;
    const bt = document.getElementById('kitBatt').value;
    const msg = document.getElementById('kitMsg');

    // Tant que les 3 ne sont pas choisis, on ne dit rien
    if (!pw || !ph || !bt) {
      if (msg) msg.textContent = '';
      setKitLocked(false);
      KIT_MODE = false;
      scheduleRun();
      return;
    }

    const kit = getSelectedKit();
    if (kit) {
      if (msg) msg.textContent = '';
      applyPresetKitObj(kit);
    } else {
      if (msg) msg.textContent = 'Combinaison non disponible dans la grille tarifaire.';
      setKitLocked(false);
      KIT_MODE = false;
      scheduleRun();
    }
  });
});


// Init listes au chargement
populateKitSelectors();
// ‚Üì Valeurs par d√©faut (ne d√©clenche pas d'appli de kit tant que la puissance est vide)
const ph = document.getElementById('kitPhase');
const bt = document.getElementById('kitBatt');
if (ph) ph.value = 'monophas√©';
if (bt) bt.value = 'none';
// Remise modifi√©e ‚Üí recalcul & affichage
document.getElementById('discountR')?.addEventListener('input', function(){
  refreshInstallPriceUI();
  scheduleRun();
});
refreshInstallPriceUI();

// Changer de kit / puissances / prix unitaires ‚Üí recalcul & affichage
['kitPower','kitPhase','kitBatt','pwr','pwrB','battKWh','battPrice','buy','buyHP','buyHC']
  .forEach(id => document.getElementById(id)?.addEventListener('input', refreshInstallPriceUI));

document.querySelectorAll('input[name="capexTariff"]').forEach(r=>{
  r.addEventListener('change', refreshInstallPriceUI);
});

// Quand on bascule d‚Äôonglet, on met √† jour l‚Äôaffichage du net (PV vs BATT)
document.querySelectorAll('.tab-btn').forEach(b=>{
  b.addEventListener('click', ()=> setTimeout(refreshInstallPriceUI, 0));
});

  /***************************************************
   *  DONN√âES PRIMES & TARIFS
   ***************************************************/
  
  const primeTarifsData = {
    "France Metropolitaine": {
      "tarif_rachat": [
        { "min": 0, "max": 3, "tarif": 0.04 },
        { "min": 4, "max": 9, "tarif": 0.04 },
        { "min": 10, "max": 36, "tarif": 0.0761 },
        { "min": 37, "max": 100, "tarif": 0.0761 },
        { "min": 101, "max": 500, "tarif": 0.0761 }
      ],
      "primes": [
        { "min": 0, "max": 3, "montant_euros_par_wc": 0.08 },
        { "min": 4, "max": 9, "montant_euros_par_wc": 0.08 },
        { "min": 10, "max": 36, "montant_euros_par_wc": 0.19 },
        { "min": 37, "max": 100, "montant_euros_par_wc": 0.10 },
        { "min": 101, "max": 500, "montant_euros_par_wc": 0.00 }
      ]
    },
    "Corse": {
      "tarif_rachat": [
        { "min": 0, "max": 3, "tarif": 0.1647 },
        { "min": 4, "max": 9, "tarif": 0.1647 },
        { "min": 10, "max": 36, "tarif": 0.0894 },
        { "min": 37, "max": 100, "tarif": 0.0894 },
        { "min": 101, "max": 500, "tarif": 0.1378 }
      ],
      "primes": [
        { "min": 0, "max": 3, "montant_euros_par_wc": 1.20 },
        { "min": 4, "max": 9, "montant_euros_par_wc": 0.68 },
        { "min": 10, "max": 36, "montant_euros_par_wc": 0.35 },
        { "min": 37, "max": 100, "montant_euros_par_wc": 0.45 },
        { "min": 101, "max": 500, "montant_euros_par_wc": 0.00 }
      ]
    },
    "Reunion": {
      "tarif_rachat": [
        { "min": 0, "max": 3, "tarif": 0.1741 },
        { "min": 4, "max": 9, "tarif": 0.1741 },
        { "min": 10, "max": 36, "tarif": 0.0894 },
        { "min": 37, "max": 100, "tarif": 0.0894 },
        { "min": 101, "max": 500, "tarif": 0.1548 }
      ],
      "primes": [
        { "min": 0, "max": 3, "montant_euros_par_wc": 1.58 },
        { "min": 4, "max": 9, "montant_euros_par_wc": 0.95 },
        { "min": 10, "max": 36, "montant_euros_par_wc": 0.56 },
        { "min": 37, "max": 100, "montant_euros_par_wc": 0.38 },
        { "min": 101, "max": 500, "montant_euros_par_wc": 0.00 }
      ]
    },
    "Guyane": {
      "tarif_rachat": [
        { "min": 0, "max": 3, "tarif": 0.1788 },
        { "min": 4, "max": 9, "tarif": 0.1788 },
        { "min": 10, "max": 36, "tarif": 0.0706 },
        { "min": 37, "max": 100, "tarif": 0.0706 },
        { "min": 101, "max": 500, "tarif": 0.1546 }
      ],
      "primes": [
        { "min": 0, "max": 3, "montant_euros_par_wc": 1.85 },
        { "min": 4, "max": 9, "montant_euros_par_wc": 1.12 },
        { "min": 10, "max": 36, "montant_euros_par_wc": 0.84 },
        { "min": 37, "max": 100, "montant_euros_par_wc": 0.58 },
        { "min": 101, "max": 500, "montant_euros_par_wc": 0.00 }
      ]
    },
    "Martinique": {
      "tarif_rachat": [
        { "min": 0, "max": 3, "tarif": 0.1788 },
        { "min": 4, "max": 9, "tarif": 0.1788 },
        { "min": 10, "max": 36, "tarif": 0.0706 },
        { "min": 37, "max": 100, "tarif": 0.0706 },
        { "min": 101, "max": 500, "tarif": 0.1562 }
      ],
      "primes": [
        { "min": 0, "max": 3, "montant_euros_par_wc": 1.75 },
        { "min": 4, "max": 9, "montant_euros_par_wc": 1.06 },
        { "min": 10, "max": 36, "montant_euros_par_wc": 0.79 },
        { "min": 37, "max": 100, "montant_euros_par_wc": 0.54 },
        { "min": 101, "max": 500, "montant_euros_par_wc": 0.00 }
      ]
    },
    "Guadeloupe": {
      "tarif_rachat": [
        { "min": 0, "max": 3, "tarif": 0.1788 },
        { "min": 4, "max": 9, "tarif": 0.1788 },
        { "min": 10, "max": 36, "tarif": 0.0706 },
        { "min": 37, "max": 100, "tarif": 0.0706 },
        { "min": 101, "max": 500, "tarif": 0.1562 }
      ],
      "primes": [
        { "min": 0, "max": 3, "montant_euros_par_wc": 1.81 },
        { "min": 4, "max": 9, "montant_euros_par_wc": 1.09 },
        { "min": 10, "max": 36, "montant_euros_par_wc": 0.82 },
        { "min": 37, "max": 100, "montant_euros_par_wc": 0.56 },
        { "min": 101, "max": 500, "montant_euros_par_wc": 0.00 }
      ]
    }
  };

  /* ===== utils ===== */
  function sum(a){var s=0;for(var i=0;i<a.length;i++)s+=a[i];return s;}
  function pctToRatio(v){var n=Number(v);if(!isFinite(n))return 0;return n>1?n/100:n;}
  function getRatio(){
  var el = document.getElementById('ratio');
  var v = el ? el.value : 70; // d√©faut 70%
  return pctToRatio(v);
}

  function computePmax(roofM2, wp){var modules=Math.floor((Number(roofM2)||0)/2);return {modules:modules,pmax:modules*(Number(wp)||0)/1000};}

  function clearMonthlyInputs(){
    var rows=[].slice.call(document.querySelectorAll('#inputsTbl tbody tr'));
    if(!rows.length) return;
    rows.forEach(function(row){
      ['HP','HC','TOT','BILL'].forEach(function(k){
        var el=row.querySelector('input[data-k="'+k+'"]');
        if(el) el.value='0';
      });
      var src=row.querySelector('.src'); if(src) src.textContent='vide';
    });
    writeSums();
  }

  /* ===== tabs ===== */
  var tabBtns=document.querySelectorAll('.tab-btn');
  var panels={tab0:document.getElementById('tab0'),tab1:document.getElementById('tab1'),tab2:document.getElementById('tab2'),tab3:document.getElementById('tab3')};
  tabBtns.forEach(function(b){
    b.addEventListener('click',function(){
      tabBtns.forEach(function(x){x.classList.remove('active')});
      b.classList.add('active');
      Object.values(panels).forEach(function(p){p.classList.remove('active')});
      panels[b.dataset.tab].classList.add('active');
      setTimeout(function(){ try{ run(); }catch(e){} }, 0);
    });
  });

  /* ========= TERRITOIRE ‚Üî AUTO TARIF & PRIME ========= */
  var currentPostcode = '';
  var currentTerritory = 'France Metropolitaine';

  function territoryFromPostcode(cp){
    if(!cp) return 'France Metropolitaine';
    const m = String(cp).match(/\b(\d{5})\b/);
    if(!m) return 'France Metropolitaine';
    const five = m[1];
    const head2 = five.slice(0,2);
    const head3 = five.slice(0,3);
    if (head2 === '20') return 'Corse';
    if (['971','972','973','974'].includes(head3)) {
      return { '971':'Guadeloupe','972':'Martinique','973':'Guyane','974':'Reunion' }[head3];
    }
    return 'France Metropolitaine';
  }

  function getBandValue(bands, pwrKw){
    if(!Array.isArray(bands)) return null;
    var p = Number(pwrKw)||0;
    for(var i=0;i<bands.length;i++){
      var b=bands[i];
      if(p>=b.min && p<=b.max) return b;
    }
    return bands[bands.length-1] || null;
  }

  // Accepte une puissance source (pwr pour onglet 2, pwrB pour onglet 3)
  function applyAutoTarifEtPrime(pwrSource){
    var terr = currentTerritory || 'France Metropolitaine';
    var data = primeTarifsData[terr] || primeTarifsData['France Metropolitaine'];
    var pwr = Number(pwrSource);
    if(!(pwr>0)) pwr = Number(document.getElementById('pwr')?.value)||0;

    var sellEl = document.getElementById('sell');
    var primeEl = document.getElementById('prime');
    var sellFlag = document.getElementById('sellAutoFlag');
    var primeFlag = document.getElementById('primeAutoFlag');
    var infoEl = document.getElementById('territoryInfo');

    var bandT = getBandValue(data.tarif_rachat, pwr);
    if(bandT && !userSellOverride){
      sellEl.value = String(bandT.tarif);
      if(sellFlag) sellFlag.textContent = '(auto : '+terr+')';
    }else if(sellFlag){ sellFlag.textContent = userSellOverride ? '(manuel)' : ''; }

    var bandP = getBandValue(data.primes, pwr);
    if(bandP && !userPrimeOverride){
      var primeAuto = Math.round((bandP.montant_euros_par_wc || 0) * (pwr*1000));
      primeEl.value = String(primeAuto);
      if(primeFlag) primeFlag.textContent = '(auto : '+terr+')';
    }else if(primeFlag){ primeFlag.textContent = userPrimeOverride ? '(manuel)' : ''; }

    if(infoEl){
      infoEl.innerHTML = 'Territoire : <b>'+terr+'</b> ‚Äî Bande tarifaire : <code>'+ (bandT? (bandT.min+'‚Äì'+bandT.max+' kWc ‚Üí '+bandT.tarif+' ‚Ç¨/kWh'):'n/a') +'</code> ‚Äî Prime : <code>'+ (bandP? (bandP.min+'‚Äì'+bandP.max+' kWc ‚Üí '+bandP.montant_euros_par_wc+' ‚Ç¨/Wc'):'n/a') +'</code>';
    }
  }

  /* =========================
     ONGLET 0 : CARTO + PVGIS
     ========================= */
  var map = L.map('map', { zoomControl: true }).setView([48.8566, 2.3522], 18);
  var googleSat = L.tileLayer(
    'https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
    {maxZoom:22,maxNativeZoom:20,subdomains:['mt0','mt1','mt2','mt3'],attribution:'Imagery ¬© Google',noWrap:true}
  ).addTo(map);

  var marker=null;
  document.getElementById('searchBtn').addEventListener('click', async function(){
    var q=document.getElementById('address').value.trim(); if(!q) return;
    var url='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q='+encodeURIComponent(q);
    try{
      var res=await fetch(url,{headers:{'Accept-Language':'fr'}});
      var data=await res.json();
      if(!data.length){ alert('Adresse introuvable'); return; }
      var lat=+data[0].lat, lon=+data[0].lon;
      map.setView([lat,lon],19);
      if(marker) map.removeLayer(marker);
      marker=L.marker([lat,lon]).addTo(map);
      document.getElementById('lat').value=lat.toFixed(6);
      document.getElementById('lng').value=lon.toFixed(6);

      var cp = '';
      if (data[0].address && data[0].address.postcode) {
        cp = (data[0].address.postcode+'').trim();
      } else {
        var m = (data[0].display_name||'').match(/\\b(\\d{5})\\b/);
        cp = m ? m[1] : '';
      }
      if(cp){
        currentPostcode = cp;
        currentTerritory = territoryFromPostcode(cp);
        document.getElementById('cp').value = cp;
        document.getElementById('territoire').value = currentTerritory;
        applyAutoTarifEtPrime();
        scheduleRun();
      }
    }catch(e){ console.error(e); alert('Erreur Nominatim'); }
  });

  var drawnItems=new L.FeatureGroup().addTo(map);
  var drawCtl = new L.Control.Draw({
    draw:{polygon:true,rectangle:true,polyline:true,marker:false,circle:false,circlemarker:false},
    edit:{featureGroup: drawnItems}
  });
  var drawOn=false;
  document.getElementById('toggleDraw').addEventListener('click',function(){
    drawOn=!drawOn; if(drawOn) map.addControl(drawCtl); else map.removeControl(drawCtl);
  });
/* ========= KITS : UI & logique ========= */


// applique le kit: puissance, batterie, capex ‚Ç¨/kWc (PV), prix batt ‚Ç¨/kWh


// (d√©)verrouillage des champs pour un kit fig√©
function setKitLocked(locked){
  KIT_MODE = !!locked;
  const ids = ['pwr','pwrB','battKWh','battPrice','sell','prime','years','buy','buyHP','buyHC','discountR','kitPriceNet'];

  ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled = locked; });

  // Radios capex
  document.querySelectorAll('input[name="capexTariff"]').forEach(r=>r.disabled = locked);

  // Couper/repermettre l‚Äôauto-croisement
  if(locked){
    window.USE_CROSS_AS_PWR   = false;
    window.USE_CROSS_AS_PWR_B = false;
    window.userPwrOverride    = true;
    window.userPwrOverrideB   = true;
    const co  = document.getElementById('crossOut');
    const coB = document.getElementById('crossOutB');
    if(co)  co.value  = '‚Äî (kit)';
    if(coB) coB.value = '‚Äî (kit)';
  } else {
    // on laisse l‚Äôutilisateur r√©activer l‚Äôauto-croisement s‚Äôil veut
  }
}




// √©v√©nements


const lockKit = document.getElementById('lockKit');
if(lockKit){
  lockKit.addEventListener('change', function(){
    setKitLocked(this.checked);
    scheduleRun();
  });
}
  function bearing(lat1,lng1,lat2,lng2){
    var toRad=function(d){return d*Math.PI/180}, toDeg=function(r){return r*180/Math.PI};
    var dLon=toRad(lng2-lng1);
    var y=Math.sin(dLon)*Math.cos(toRad(lat2));
    var x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2)) - Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(dLon);
    var brng=(toDeg(Math.atan2(y,x))+360)%360; // 0=N
    var az=brng-180; if(az>180) az-=360; if(az<-180) az+=360; // 0=Sud, Est=-90, Ouest=+90
    return az;
  }

  map.on(L.Draw.Event.CREATED, function(e){
    var layer=e.layer;
    drawnItems.addLayer(layer);

    if(e.layerType==='polygon' || e.layerType==='rectangle'){
      var latlngs=layer.getLatLngs()[0] || layer.getLatLngs();
      var area_m2=L.GeometryUtil.geodesicArea(latlngs);
      document.getElementById('area').value=Math.round(area_m2);
      var roofEl=document.getElementById('roof');
      if(roofEl){
        roofEl.value = Math.round(area_m2);
        roofEl.dispatchEvent(new Event('input', {bubbles:true}));
      }
    }

    if(e.layerType==='polyline'){
      var pts=layer.getLatLngs();
      if(pts.length>=2){
        var a=pts[0], b=pts[pts.length-1];
        var az=bearing(a.lat,a.lng,b.lat,b.lng);
        document.getElementById('azimut').value=az.toFixed(1);
        drawnItems.removeLayer(layer);
      }
    }
  });

  async function fetchPVGIS(lat,lon,tiltDeg,aspectDeg){
    var base = 'https://re.jrc.ec.europa.eu/api/v5_2/PVcalc?outputformat=basic'
            + '&lat='+lat+'&lon='+lon+'&raddatabase=PVGIS-SARAH2'
            + '&peakpower=1&loss=14&pvtechchoice=crystSi'
            + '&angle='+tiltDeg+'&aspect='+aspectDeg+'&usehorizon=1';
    var url='https://corsproxy.io/?url='+encodeURIComponent(base);
    var res=await fetch(url);
    if(!res.ok) throw new Error('PVGIS indisponible');
    var txt=await res.text();
    var year=null, monthly=[];
    txt.split('\n').forEach(function(line){
      var L=line.trim(); if(!L) return;
      if(L.startsWith('Year')){ var parts=L.split('\t'); if(parts[1]) year=parseFloat(parts[1]); }
      if(/^\d+\s/.test(L)){
        var p=L.split('\t').map(function(s){return s.trim()});
        if(p.length>=3){
          var m = parseInt(p[0],10);
          var Em = parseFloat(p[2]);
          if(isFinite(m)&&isFinite(Em)) monthly.push({month:m, Em:Em});
        }
      }
    });
    return {year:year, monthly:monthly};
  }
  function fillMonthlyTable(rows){
    var names=MONTHS;
    var tb=document.querySelector('#monthly tbody'); tb.innerHTML='';
    rows.forEach(function(r){
      var tr=document.createElement('tr');
      tr.innerHTML='<td>'+ (names[r.month-1]||('M'+r.month)) +'</td><td>'+ FR0.format(r.Em) +'</td>';
      tb.appendChild(tr);
    });
  }
  function applyPVGISMonthlyToSimulator(rows){
    var P1new = new Array(12).fill(0);
    rows.forEach(function(r){
      if(r.month>=1 && r.month<=12 && isFinite(r.Em)) P1new[r.month-1]=r.Em;
    });
    for(var i=0;i<12;i++){ if(!(P1new[i]>0)) P1new[i]=window.P1[i]; }
    window.P1 = P1new;
    userPwrOverride = false;
    userPwrOverrideB = false;
    scheduleRun();
  }
  document.getElementById('calcPV').addEventListener('click', async function(){
    var lat=parseFloat(document.getElementById('lat').value);
    var lon=parseFloat(document.getElementById('lng').value);
    var tilt=parseFloat(document.getElementById('tilt').value)||35;
    var asp=parseFloat(document.getElementById('azimut').value||'0');
    if(isNaN(lat)||isNaN(lon)){ alert('Renseigne d‚Äôabord l‚Äôadresse.'); return; }
    try{
      var out=await fetchPVGIS(lat,lon,tilt,asp);
      if(out.year!=null && out.monthly.length){
        document.getElementById('productible').value = FR0.format(Math.round(out.year));
        fillMonthlyTable(out.monthly);
        applyPVGISMonthlyToSimulator(out.monthly);
      }else{
        alert('Productible introuvable.');
      }
    }catch(e){ console.error(e); alert('Erreur PVGIS'); }
  });

  /* =========================
     ONGLET 1 + 2 : SIMULATEUR PV seul
     ========================= */
  function buildRows(initialTot, ratio){
    var tb=document.querySelector('#inputsTbl tbody'); tb.innerHTML='';
    for(var i=0;i<12;i++){
      var tot=Math.round(initialTot?initialTot[i]:defaultsCTot[i]);
      var hp=Math.round(tot*(ratio||0.7));
      var hc=tot-hp;
      var tr=document.createElement('tr');
      tr.innerHTML =
        '<td>'+MONTHS[i]+'</td>'+
        '<td><input type="number" step="1" data-k="HP" value="'+hp+'"></td>'+
        '<td><input type="number" step="1" data-k="HC" value="'+hc+'"></td>'+
        '<td><input type="number" step="1" data-k="TOT" value="'+(hp+hc)+'"></td>'+
        '<td><input type="number" step="0.01" data-k="BILL" value="0" class="readonly" readonly></td>'+
        '<td class="src small">init</td>';
      tb.appendChild(tr);
    }
    writeSums();
  }
  function readRows(){
    var rows=[].slice.call(document.querySelectorAll('#inputsTbl tbody tr'));
    var HP=[],HC=[],TOT=[],BILL=[];
    for(var i=0;i<rows.length;i++){
      HP.push(Number(rows[i].querySelector('input[data-k="HP"]').value)||0);
      HC.push(Number(rows[i].querySelector('input[data-k="HC"]').value)||0);
      TOT.push(Number(rows[i].querySelector('input[data-k="TOT"]').value)||0);
      BILL.push(Number(rows[i].querySelector('input[data-k="BILL"]').value)||0);
    }
    return {HP:HP,HC:HC,TOT:TOT,BILL:BILL};
  }
  function writeSums(){
    var R=readRows();
    document.getElementById('HPsum').textContent=FR0.format(sum(R.HP));
    document.getElementById('HCsum').textContent=FR0.format(sum(R.HC));
    document.getElementById('TOTsum').textContent=FR0.format(sum(R.TOT));
    document.getElementById('BILLsum').textContent=EUR2.format(sum(R.BILL));
  }

  var mode='A';
  function setMode(m){
    mode=m;
    document.getElementById('helpA').classList.toggle('hidden', m!=='A');
    document.getElementById('helpB').classList.toggle('hidden', m!=='B');
    document.getElementById('helpC').classList.toggle('hidden', m!=='C');
    document.getElementById('subC').classList.toggle('hidden', m!=='C');

    document.querySelectorAll('[data-show]').forEach(function(n){
      var show=n.getAttribute('data-show').split(/\s+/).indexOf(m)>=0;
      n.classList.toggle('hidden', !show);
    });

    var rows=[].slice.call(document.querySelectorAll('#inputsTbl tbody tr'));
    rows.forEach(function(row){
      var iHP=row.querySelector('input[data-k="HP"]');
      var iHC=row.querySelector('input[data-k="HC"]');
      var iTOT=row.querySelector('input[data-k="TOT"]');
      var iBILL=row.querySelector('input[data-k="BILL"]');
      if(m==='A'){
        iHP.readOnly=false; iHP.classList.remove('readonly');
        iHC.readOnly=false; iHC.classList.remove('readonly');
        iTOT.readOnly=true;  iTOT.classList.add('readonly');
        iBILL.readOnly=true; iBILL.classList.add('readonly');
        row.querySelector('.src').textContent='HP/HC saisis';
      }else if(m==='B'){
        iHP.readOnly=true;  iHP.classList.add('readonly');
        iHC.readOnly=true;  iHC.classList.add('readonly');
        iTOT.readOnly=false; iTOT.classList.remove('readonly');
        iBILL.readOnly=true; iBILL.classList.add('readonly');
        row.querySelector('.src').textContent='Ventil√© ratio';
      }else{
        var cMode=getCMode();
        iHP.readOnly=true;  iHP.classList.add('readonly');
        iHC.readOnly=true;  iHC.classList.add('readonly');
        iTOT.readOnly=true; iTOT.classList.add('readonly');
        iBILL.readOnly=(cMode==='avg'); iBILL.classList.toggle('readonly', cMode==='avg');
        row.querySelector('.src').textContent='‚Ç¨‚ÜíkWh vent.';
      }
    });

    updateAlerts();
    clearMonthlyInputs();
    scheduleRun();
  }
  function getCMode(){var el=document.querySelector('input[name="cBillMode"]:checked');return el?el.value:'avg';}
  function updateAlerts(){
    var msg=[];
    if(mode==='B'){
      var r=pctToRatio(document.getElementById('ratio').value);
      if(!(r>0 && r<1)) msg.push('Indique un Ratio HP (%) r√©aliste (ex. 70).');
    }
    if(mode==='C'){
      var buy=Number(document.getElementById('buy').value)||0;
      var buyHP=Number(document.getElementById('buyHP').value)||0;
      var buyHC=Number(document.getElementById('buyHC').value)||0;
      var r=pctToRatio(document.getElementById('ratio').value);
      var price=0; if(buyHP>0 && buyHC>0) price=r*buyHP+(1-r)*buyHC; else if(buy>0) price=buy;
      if(!(price>0)) msg.push('Saisis un tarif Global ou bien HP & HC + Ratio pour convertir ‚Ç¨ ‚Üí kWh.');
      var cMode=getCMode();
      if(cMode==='avg'){
        var avgBill=Number(document.getElementById('avgBill').value)||0;
        if(!(avgBill>0)) msg.push('Renseigne la Facture mensuelle moyenne (‚Ç¨).');
      }else{
        var R=readRows();
        if(sum(R.BILL)<=0) msg.push('Saisis la colonne Facture (‚Ç¨) mensuelle.');
      }
    }
    document.getElementById('alerts1').innerHTML=(msg.length?('<div class="pill warn">'+msg.join(' ')+'</div>'):'');
  }

  function recalcByMode(){
    var rows=[].slice.call(document.querySelectorAll('#inputsTbl tbody tr'));
    var ratio = getRatio();
    var buyHP=Number(document.getElementById('buyHP').value)||0;
    var buyHC=Number(document.getElementById('buyHC').value)||0;

    if(mode==='A'){
      rows.forEach(function(row){
        var hp=Number(row.querySelector('input[data-k="HP"]').value)||0;
        var hc=Number(row.querySelector('input[data-k="HC"]').value)||0;
        row.querySelector('input[data-k="TOT"]').value=hp+hc;
        var bill=(buyHP>0||buyHC>0) ? (hp*buyHP + hc*buyHC) : 0;
        var billEl=row.querySelector('input[data-k="BILL"]');
        if(billEl) billEl.value = bill ? bill.toFixed(2) : '0';
      });
    }else if(mode==='B'){
      rows.forEach(function(row){
        var tot=Number(row.querySelector('input[data-k="TOT"]').value)||0;
        var hp=Math.round(tot*ratio), hc=tot-hp;
        row.querySelector('input[data-k="HP"]').value=hp;
        row.querySelector('input[data-k="HC"]').value=hc;
        var bill=(buyHP>0||buyHC>0) ? (hp*buyHP + hc*buyHC) : 0;
        var billEl=row.querySelector('input[data-k="BILL"]');
        if(billEl) billEl.value = bill ? bill.toFixed(2) : '0';
      });
    }else{
      var buy=Number(document.getElementById('buy').value)||0;
      var price=0;
      if(buyHP>0 && buyHC>0) price=ratio*buyHP+(1-ratio)*buyHC; else if(buy>0) price=buy;
      var cMode=getCMode();
      rows.forEach(function(row){
        var billInput=row.querySelector('input[data-k="BILL"]');
        var bill=Number(billInput.value)||0;
        if(cMode==='avg'){
          bill=Number(document.getElementById('avgBill').value)||0;
          billInput.value=(bill>0?bill.toFixed(2):'0');
        }
        if(price>0 && bill>0){
          var tot=bill/price;
          var hp=Math.round(tot*ratio), hc=Math.round(tot*(1-ratio));
          var diff=Math.round(tot)-(hp+hc); if(diff!==0) hp+=diff;
          row.querySelector('input[data-k="TOT"]').value=Math.round(tot);
          row.querySelector('input[data-k="HP"]').value=Math.max(0,hp);
          row.querySelector('input[data-k="HC"]').value=Math.max(0,Math.round(tot)-hp);
        }else{
          row.querySelector('input[data-k="TOT"]').value=0;
          row.querySelector('input[data-k="HP"]').value=0;
          row.querySelector('input[data-k="HC"]').value=0;
        }
      });
    }
    writeSums();
  }

  function readInputsAll(){
    var R=readRows();
    return {
      HP:R.HP, HC:R.HC, TOT:R.TOT, BILL:R.BILL,
      P1:window.P1.slice(),
      pwr:Number(document.getElementById('pwr').value)||0,
      buy:Number(document.getElementById('buy').value)||0,
      buyHP:Number(document.getElementById('buyHP').value)||0,
      buyHC:Number(document.getElementById('buyHC').value)||0,
      sell:Number(document.getElementById('sell').value)||0,
      capex:(function(){var r=document.querySelector('input[name="capexTariff"]:checked');return r?(Number(r.value)||0):2150;})(),
      prime:Number(document.getElementById('prime').value)||0,
      inc:pctToRatio(document.getElementById('inc').value),
      years:Math.max(1,Math.floor(Number(document.getElementById('years').value)||25))
    };
  }

  function compute(p){
    var P = p.P1.map(function(v){ return v * p.pwr; });
    var selfHP     = P.map(function(pv,i){ return Math.min(pv, p.HP[i]); });
    var surplusHP  = P.map(function(pv,i){ return Math.max(pv - p.HP[i], 0); });
    var gridHPHC   = P.map(function(pv,i){ return p.HC[i] + Math.max(p.HP[i] - pv, 0); });

    var Csum=sum(p.TOT), Psum=sum(P);
    var selfSum   = sum(selfHP);
    var surplusSum= sum(surplusHP);
    var gridSum   = sum(gridHPHC);

    var priceHP=(p.buyHP>0?p.buyHP:p.buy);
    var econY0 = selfSum * priceHP;
    var sellY0 = surplusSum * p.sell;

    var yearly=[], cum=0, totSave=0;
    for(var y=1;y<=p.years;y++){
      var priceHPy = priceHP*Math.pow(1+p.inc,y-1);
      var saveY = selfSum * priceHPy;
      var sellY = sellY0;
      var eTot  = saveY + sellY;
      totSave += saveY; cum += eTot;
      yearly.push({year:y, e:eTot, cum:cum});
    }
    var totSell = p.years*sellY0;
    var totAll  = totSave + totSell;

    // -- Prix installation (PV seul) : on prend le prix net si dispo
var capexTot;
var netPV = getEffectiveInstallPrice('PV');
if (isFinite(netPV) && netPV > 0) {
  capexTot = netPV;
} else if (p.kit && (p.kit.price_pv_eur || p.kit.price_total_eur)) {
  capexTot = Number(p.kit.price_pv_eur ?? p.kit.price_total_eur) || 0;
} else {
  capexTot = p.pwr * p.capex;
}


    var costReal=Math.max(0,capexTot-(p.prime||0));
    var payback='> '+p.years, acc=0, prevAcc=0, prevY=0;
    for(var y=1;y<=p.years;y++){
      var flow = selfSum * (priceHP*Math.pow(1+p.inc,y-1)) + sellY0;
      acc+=flow;
      if(acc>=costReal){
        if(prevAcc===0){ payback=String(y); break; }
        var rem=costReal-prevAcc, frac=rem/(acc-prevAcc);
        payback=(prevY+frac).toFixed(1); break;
      }
      prevAcc=acc; prevY=y;
    }

    var aut    = Csum>0 ? selfSum/Csum : 0;
    var sc     = Psum>0 ? selfSum/Psum : 0;
    var revPct = Psum>0 ? surplusSum/Psum : 0;

    return {
      P:P, TOT:p.TOT, HP:p.HP, HC:p.HC,
      selfHP:selfHP,
      Csum:Csum, Psum:Psum, selfSum:selfSum,
      surplusSum:surplusSum, gridSum:gridSum, selfHPSum:selfSum,
      econ1:econY0, sell1:sellY0,
      yearly:yearly, totSave:totSave, totSell:totSell, totAll:totAll,
      capexTot:capexTot, costReal:costReal, payback:payback,
      aut:aut, sc:sc, revPct:revPct
    };
  }

  /* =========================
     PV + Batterie : calculs
     ========================= */
  const DAYS = [31,28,31,30,31,30,31,31,30,31,30,31];

  function computeBattAll(p, B_kWh, battPrice){
    const priceHP0 = (p.buyHP>0 ? p.buyHP : p.buy);
    const priceHC0 = (p.buyHC>0 ? p.buyHC : p.buy);
    const sell0    = p.sell;

    const P = p.P1.map(v => v * p.pwr);
    const selfHP = new Array(12).fill(0);
    const coverHC = new Array(12).fill(0);
    const sellK = new Array(12).fill(0);
    const buyHPk = new Array(12).fill(0);
    const buyHCk = new Array(12).fill(0);

    const Buse = B_kWh;

    for(let m=0;m<12;m++){
      const days = DAYS[m];
      const E_pv = P[m] || 0;
      const E_HP = p.HP[m] || 0;
      const E_HC = p.HC[m] || 0;

      const sHP = Math.min(E_pv, E_HP);
      const surplus = Math.max(E_pv - sHP, 0);
      const bHP = Math.max(E_HP - sHP, 0);

      const charge_m = Math.min(surplus, Buse * days);
      const cover_m  = Math.min(charge_m, E_HC);
      const sell_m   = Math.max(surplus - charge_m, 0);
      const buyHC_m  = Math.max(E_HC - cover_m, 0);

      selfHP[m] = sHP;
      coverHC[m] = cover_m;
      sellK[m] = sell_m;
      buyHPk[m] = bHP;
      buyHCk[m] = buyHC_m;
    }

    const Csum = sum(p.TOT);
    const Psum = sum(P);
    const selfSum = sum(selfHP) + sum(coverHC);
    const surplusSum = sum(sellK);
    const gridSum = sum(buyHPk) + sum(buyHCk);

    const save1 = sum(selfHP)*priceHP0 + sum(coverHC)*priceHC0;
    const sell1 = surplusSum*sell0;

    const yearly=[], inc=p.inc, years=p.years;
    let cum=0, totSave=0;
    for(let y=1;y<=years;y++){
      const priceHPy = priceHP0*Math.pow(1+inc,y-1);
      const priceHCy = priceHC0*Math.pow(1+inc,y-1);
      const saveY = sum(selfHP)*priceHPy + sum(coverHC)*priceHCy;
      const sellY = sell1;
      const eTot  = saveY + sellY;
      totSave += saveY; cum += eTot;
      yearly.push({year:y, e:eTot, cum:cum});
    }
    const totSell = years*sell1;
    const totAll  = totSave + totSell;

    // -- Prix installation (PV + batt) : prix net si dispo
let capexTot;
const netB = getEffectiveInstallPrice('BATT');
if (isFinite(netB) && netB > 0) {
  capexTot = netB;
} else if (p.kit && (p.kit.price_pv_eur || p.kit.price_total_eur)) {
  const pv   = Number(p.kit.price_pv_eur ?? 0);
  const batt = Number(p.kit.price_batt_eur ?? ((p.kit.price_total_eur ?? 0) - pv));
  capexTot = pv + batt;
} else {
  capexTot = (p.pwr*p.capex) + (B_kWh * (Number(battPrice)||0));
}


    const costReal = Math.max(0, capexTot - (p.prime||0));
    let payback='> '+years, acc=0, prevAcc=0, prevY=0;
    for(let y=1;y<=years;y++){
      const priceHPy = priceHP0*Math.pow(1+inc,y-1);
      const priceHCy = priceHC0*Math.pow(1+inc,y-1);
      const flow = sum(selfHP)*priceHPy + sum(coverHC)*priceHCy + sell1;
      acc+=flow;
      if(acc>=costReal){
        if(prevAcc===0){ payback=String(y); break; }
        const rem=costReal-prevAcc, frac=rem/(acc-prevAcc);
        payback=(prevY+frac).toFixed(1); break;
      }
      prevAcc=acc; prevY=y;
    }

    const aut    = Csum>0 ? selfSum/Csum : 0;
    const sc     = Psum>0 ? selfSum/Psum : 0;
    const revPct = Psum>0 ? surplusSum/Psum : 0;

    return {
      P, TOT:p.TOT.slice(), HP:p.HP.slice(), HC:p.HC.slice(),
      selfHP, coverHC, sellK, buyHPk, buyHCk,
      Csum,Psum,selfHPSum:selfSum,surplusSum,gridSum,
      econ1:save1, sell1:sell1,
      yearly, totSave, totSell, totAll,
      capexTot, costReal, payback,
      aut, sc, revPct
    };
  }

  /* ===== RENDUS PV seul ===== */
  function renderMonth(p,r){
    var tb=document.querySelector('#monthTbl tbody'); tb.innerHTML='';
    var priceHP=(Number(document.getElementById('buyHP').value)||Number(document.getElementById('buy').value)||0);
    var sell=Number(document.getElementById('sell').value)||0;

    var totalEtot=0;
    for(var i=0;i<12;i++){
      var prod=r.P[i], hp=p.HP[i], hc=p.HC[i], cons=p.TOT[i];
      var selfHP=Math.min(prod,hp);
      var revK=Math.max(prod-hp,0);
      var buyK=hc + Math.max(hp - prod,0);
      var euroSave=selfHP*priceHP, euroSell=revK*sell, euroTot=euroSave+euroSell;
      totalEtot+=euroTot;

      var tr=document.createElement('tr');
      tr.innerHTML =
        '<td>'+MONTHS[i]+'</td>'+
        '<td>'+FR0.format(cons)+' kWh</td>'+
        '<td>'+FR0.format(prod)+' kWh</td>'+
        '<td>'+FR0.format(selfHP)+' kWh</td>'+
        '<td>'+FR0.format(revK)+' kWh</td>'+
        '<td>'+FR0.format(buyK)+' kWh</td>'+
        '<td>'+EUR2.format(euroSave)+'</td>'+
        '<td>'+EUR2.format(euroSell)+'</td>'+
        '<td>'+EUR2.format(euroTot)+'</td>';
      tb.appendChild(tr);
    }
    document.getElementById('t_C').textContent   = FR0.format(r.Csum)+' kWh';
    document.getElementById('t_P').textContent   = FR0.format(r.Psum)+' kWh';
    document.getElementById('t_Ekwh').textContent= FR0.format(r.selfHPSum)+' kWh';
    document.getElementById('t_Rkwh').textContent= FR0.format(r.surplusSum)+' kWh';
    document.getElementById('t_Buy').textContent = FR0.format(r.gridSum)+' kWh';
    document.getElementById('t_Save').textContent= EUR2.format(r.econ1);
    document.getElementById('t_Sell').textContent= EUR2.format(r.sell1);
    document.getElementById('t_Etot').textContent= EUR2.format(totalEtot);
  }
  function renderYearTable(yearly){
  var tb = document.querySelector('#yearTbl tbody');
  tb.innerHTML = '';

  var primeVal = Math.max(0, Number(document.getElementById('prime').value) || 0);

  var cum = 0;
  for (var i = 0; i < yearly.length; i++) {
    var addPrime   = (i === 1) ? primeVal : 0;            // ann√©e 2
    var eThisYear  = yearly[i].e + addPrime;
    cum += eThisYear;

    var label = EUR2.format(eThisYear);
    if (addPrime > 0) {
      label += ' <span class="small" style="color:#9bb0c6">dont ' + EUR0.format(primeVal) + ' de prime</span>';
    }

    var tr = document.createElement('tr');
    tr.innerHTML =
      '<td>' + yearly[i].year + '</td>' +
      '<td>' + label + '</td>' +
      '<td>' + EUR2.format(cum) + '</td>';
    tb.appendChild(tr);
  }
}

  function renderKPIs(p,r){
    document.getElementById('k_aut').textContent=(r.aut*100).toFixed(1)+' %';
    document.getElementById('k_sc').textContent=(r.sc*100).toFixed(1)+' %';
    document.getElementById('k_rev').textContent=(r.revPct*100).toFixed(1)+' %';
    document.getElementById('k_yearsA').textContent=document.getElementById('years').value;
    document.getElementById('k_yearsB').textContent=document.getElementById('years').value;
    document.getElementById('k_yearsC').textContent=document.getElementById('years').value;
    var avgMonth = (r.totAll / (Math.max(1,Number(document.getElementById('years').value))*12)) || 0;
    document.getElementById('k_yearsD').textContent=document.getElementById('years').value;
    document.getElementById('k_avgMonth').textContent=EUR0.format(avgMonth);
    document.getElementById('k_totAll').textContent=EUR0.format(r.totAll);
    document.getElementById('k_totSave').textContent=EUR0.format(r.totSave);
    document.getElementById('k_totSell').textContent=EUR0.format(r.totSell);
    document.getElementById('k_capex').textContent=EUR0.format(r.capexTot);
    document.getElementById('k_prime').textContent=EUR0.format((Number(document.getElementById('prime').value)||0));
    document.getElementById('k_costreal').textContent=EUR0.format(r.costReal);
    document.getElementById('k_roi').textContent=r.payback+' ans';
  }
  function renderChart(p,pmaxInfo){
    var svg=document.getElementById('chart');
    var w=svg.clientWidth||svg.getBoundingClientRect().width||900;
    var h=Number(svg.getAttribute('height'))||280;
    var pad={l:42,r:12,t:10,b:26};
    svg.setAttribute('viewBox','0 0 '+w+' '+h);
    while(svg.firstChild) svg.removeChild(svg.firstChild);

    var pmax=(pmaxInfo&&isFinite(pmaxInfo.pmax))?pmaxInfo.pmax:NaN;
    var pmaxOut=document.getElementById('pmaxOut'); if(pmaxOut){ pmaxOut.value=isFinite(pmax)?pmax.toFixed(2):'‚Äî'; }
    var crossOutEl=document.getElementById('crossOut'); if(crossOutEl){ crossOutEl.value='‚Äî'; }

    if(!isFinite(pmax)||pmax<1){
      var txt=document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x',16);txt.setAttribute('y',24);txt.setAttribute('fill','#97a6ba');
      txt.textContent='Renseigne Surface & Puissance module pour calculer Pmax (graphique : 1 ‚Üí Pmax).';
      svg.appendChild(txt); return;
    }

    var points=[], step;
    if(pmax<=50) step=1; else if(pmax<=120) step=2; else step=Math.ceil(pmax/60);
    for(var x=1;x<=pmax+1e-9;x+=step){
      var r=compute({HP:p.HP.slice(),HC:p.HC.slice(),TOT:p.TOT.slice(),P1:p.P1.slice(),pwr:x,
        buy:p.buy,buyHP:p.buyHP,buyHC:p.buyHC,sell:p.sell,capex:p.capex,prime:p.prime,inc:p.inc,years:p.years});
      points.push({x:x, aut:r.aut*100, sc:r.sc*100, rev:r.revPct*100});
    }

    var crossP=NaN;
    for(var i=1;i<points.length;i++){
      var d0=points[i-1].aut-points[i-1].sc, d1=points[i].aut-points[i].sc;
      if((d0<=0&&d1>=0)||(d0>=0&&d1<=0)){ var t=(0-d0)/(d1-d0); crossP=points[i-1].x+(points[i].x-points[i-1].x)*t; break; }
    }
    var pwrEl=document.getElementById('pwr');
    var pick=(isFinite(crossP)?Math.round(crossP):NaN);
    if(isFinite(pick)) pick=Math.max(1, Math.min(pick, Math.round(pmax)));
    if(crossOutEl) crossOutEl.value=(isFinite(pick)?String(pick):'‚Äî');
var lockKitEl = document.getElementById('lockKit');
var kitLocked = (lockKitEl && lockKitEl.checked) || KIT_MODE;

// Affichage du croisement sans √©craser pwr quand kit actif
if (crossOutEl) crossOutEl.value = kitLocked ? '‚Äî (kit)' : (isFinite(pick) ? String(pick) : '‚Äî');

// Ne PAS √©craser la puissance si kit actif/verrouill√©
if (USE_CROSS_AS_PWR && !userPwrOverride && !kitLocked && isFinite(pick) && pwrEl) {
  var cur=Math.max(1, Math.round(Number(pwrEl.value)||0));
  if(cur!==pick){
    pwrEl.value=String(pick);
    applyAutoTarifEtPrime(pick);
    scheduleRun();
  }
}


    var maxX=pmax, maxY=100, minY=0;
    var W=w-pad.l-pad.r, H=h-pad.t-pad.b;
    function sx(x){return pad.l+(x-1)*(W/(maxX-1));}
    function sy(y){return pad.t+H-((y-minY)/(maxY-minY))*H;}

    for(var gy=0;gy<=5;gy++){
      var yv=gy*20, y=sy(yv);
      var line=document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1',pad.l); line.setAttribute('x2',pad.l+W);
      line.setAttribute('y1',y); line.setAttribute('y2',y);
      line.setAttribute('stroke','#233040'); line.setAttribute('stroke-width','1'); svg.appendChild(line);
      var lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x',6); lbl.setAttribute('y',y+4); lbl.setAttribute('fill','#97a6ba'); lbl.setAttribute('font-size','10');
      lbl.textContent=yv+'%'; svg.appendChild(lbl);
    }
    var nXTicks=6;
    for(var gx=0;gx<nXTicks;gx++){
      var xv=1+gx*(maxX-1)/(nXTicks-1), lx=sx(xv), ly=pad.t+H+14;
      var tx=document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.setAttribute('x',lx); tx.setAttribute('y',ly); tx.setAttribute('text-anchor','middle');
      tx.setAttribute('fill','#97a6ba'); tx.setAttribute('font-size','10');
      tx.textContent=xv.toFixed(0)+' kWc'; svg.appendChild(tx);
    }
    function makePath(arr,key){var d='';for(var j=0;j<arr.length;j++){var px=sx(arr[j].x),py=sy(arr[j][key]);d+=(j===0?'M':' L')+px+' '+py;}return d;}
    var pathAut=document.createElementNS('http://www.w3.org/2000/svg','path'); pathAut.setAttribute('d',makePath(points,'aut')); pathAut.setAttribute('fill','none'); pathAut.setAttribute('stroke','#3da5ff'); pathAut.setAttribute('stroke-width','2'); svg.appendChild(pathAut);
    var pathSc=document.createElementNS('http://www.w3.org/2000/svg','path'); pathSc.setAttribute('d',makePath(points,'sc')); pathSc.setAttribute('fill','none'); pathSc.setAttribute('stroke','#30d158'); pathSc.setAttribute('stroke-width','2'); svg.appendChild(pathSc);
    var pathRev=document.createElementNS('http://www.w3.org/2000/svg','path'); pathRev.setAttribute('d',makePath(points,'rev')); pathRev.setAttribute('fill','none'); pathRev.setAttribute('stroke','#ffb020'); pathRev.setAttribute('stroke-width','2'); svg.appendChild(pathRev);

    if (crossOutEl && !crossOutEl._dbl) {
      crossOutEl._dbl = true;
      crossOutEl.addEventListener('dblclick', function(){
        userPwrOverride = false;
        scheduleRun();
      });
    }
  }

  /* ========= Graphique Factures 20 ans ========= */
  function computeAnnualBillBase(p){
    var hpSum = sum(p.HP), hcSum = sum(p.HC), totSum = sum(p.TOT);
    if ((p.buyHP>0) || (p.buyHC>0)) {
      return hpSum * (p.buyHP||0) + hcSum * (p.buyHC||0);
    } else if (p.buy > 0) {
      return totSum * p.buy;
    } else {
      return 0;
    }
  }
  function renderBillsGrowthChart(p){
    var svg = document.getElementById('billChart');
    if(!svg) return;
    var incSpan = document.getElementById('billIncPct');
    if (incSpan) incSpan.textContent = ((p.inc||0)*100).toFixed(1).replace(/\\.0$/,'') + ' %/an';

    var w = svg.clientWidth || svg.getBoundingClientRect().width || 900;
    var h = Number(svg.getAttribute('height')) || 320;
    var pad = {l:64, r:16, t:28, b:58};

    svg.setAttribute('viewBox','0 0 '+w+' '+h);
    while (svg.firstChild) svg.removeChild(svg.firstChild);

    var base = computeAnnualBillBase(p);
    var years = 20, inc = p.inc||0;
    var startYear = (new Date()).getFullYear();

    var vals = [], max = 0, labels = [];
    for (var i=0;i<years;i++){
      var v = base * Math.pow(1+inc, i);
      vals.push(v); if (v>max) max=v;
      labels.push(String(startYear + i));
    }

    if (!(max > 0)){
      var txt=document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x',16); txt.setAttribute('y',28); txt.setAttribute('fill','#97a6ba');
      txt.textContent='Renseignez tarifs et consommations pour calculer la facture.';
      svg.appendChild(txt); return;
    }

    var stepY = Math.pow(10, Math.max(2, String(Math.floor(max)).length - 2));
    var niceMax = Math.ceil(max / stepY) * stepY;

    var W = w - pad.l - pad.r, H = h - pad.t - pad.b;
    var band = W / years;
    var barW = band * 0.65;

    function sx(i){ return pad.l + i*band + (band - barW)/2; }
    function sy(v){ return pad.t + H - (v / niceMax) * H; }

    var ticks = 5;
    for (var t=0; t<=ticks; t++){
      var yv = niceMax * t / ticks, y = sy(yv);
      var gl = document.createElementNS('http://www.w3.org/2000/svg','line');
      gl.setAttribute('x1', pad.l); gl.setAttribute('x2', pad.l + W);
      gl.setAttribute('y1', y);     gl.setAttribute('y2', y);
      gl.setAttribute('stroke', '#233040'); gl.setAttribute('stroke-width','1');
      svg.appendChild(gl);

      var gy = document.createElementNS('http://www.w3.org/2000/svg','text');
      gy.setAttribute('x', pad.l - 8); gy.setAttribute('y', y + 4);
      gy.setAttribute('text-anchor','end'); gy.setAttribute('fill','#97a6ba');
      gy.setAttribute('font-size','11');
      gy.textContent = EUR0.format(yv);
      svg.appendChild(gy);
    }

    for (var i=0;i<years;i++){
      var v = vals[i];
      var x = sx(i), y = sy(v), bh = pad.t + H - y;

      var rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x', x); rect.setAttribute('y', y);
      rect.setAttribute('width', barW); rect.setAttribute('height', Math.max(0,bh));
      rect.setAttribute('rx','6'); rect.setAttribute('ry','6');
      rect.setAttribute('fill', '#d35b66');
      svg.appendChild(rect);

      var lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.textContent = EUR0.format(v).replace(/\\s?‚Ç¨/, '‚Ç¨');
      lbl.setAttribute('text-anchor','middle');
      lbl.setAttribute('font-size','12');
      lbl.setAttribute('x', x + barW/2);
      lbl.setAttribute('y', y - 6);
      lbl.setAttribute('fill', '#cfe1f1');
      lbl.setAttribute('style','paint-order:stroke;stroke:#0b0f14;stroke-width:2px');
      svg.appendChild(lbl);

      var tx = document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.textContent = labels[i];
      tx.setAttribute('x', x + barW/2);
      tx.setAttribute('y', pad.t + H + 16);
      tx.setAttribute('text-anchor','middle');
      tx.setAttribute('fill','#97a6ba');
      tx.setAttribute('font-size','11');
      tx.setAttribute('transform','rotate(-28 '+(x+barW/2)+' '+(pad.t+H+16)+')');
      svg.appendChild(tx);
    }

    var ytitle = document.createElementNS('http://www.w3.org/2000/svg','text');
    ytitle.setAttribute('x', pad.l);
    ytitle.setAttribute('y', pad.t - 8);
    ytitle.setAttribute('fill','#9bb0c6');
    ytitle.setAttribute('font-size','12');
    ytitle.textContent = 'Montant annuel estim√© (‚Ç¨)';
    svg.appendChild(ytitle);
  }

  /* ======= Comparaison factures sans / avec PV ======= */
  function renderBillsCompareChart(p, r){
    var svg = document.getElementById('billCompareChart');
    if(!svg) return;
    var w = svg.clientWidth || svg.getBoundingClientRect().width || 900;
    var h = Number(svg.getAttribute('height')) || 360;
    var pad = {l:64, r:16, t:28, b:58};
    svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
    while (svg.firstChild) svg.removeChild(svg.firstChild);

    var years = 20;
    var inc   = p.inc || 0;
    var base1 = computeAnnualBillBase(p);
    var startYear = (new Date()).getFullYear();
    var prime = Number(document.getElementById('prime').value) || 0;

    var baseVals = [], withPVVals = [];
    var maxPos = 0, minNeg = 0;

    for (var i=0;i<years;i++){
      var baseY = base1 * Math.pow(1+inc, i);
      var econY = (r && r.yearly && r.yearly[i]) ? r.yearly[i].e : 0;
      var withPV = baseY - (econY + (i===1 ? prime : 0));
      baseVals.push(baseY);
      withPVVals.push(withPV);
      if (baseY > maxPos) maxPos = baseY;
      if (withPV < minNeg) minNeg = withPV;
    }

    var maxAbs = Math.max(maxPos, Math.abs(minNeg), 1);
    function niceCeil(v){
      var p = Math.pow(10, Math.max(2, Math.floor(Math.log10(v)) - 1));
      return Math.ceil(v/p)*p;
    }
    var yMax = niceCeil(maxAbs);

    var W = w - pad.l - pad.r, H = h - pad.t - pad.b;
    function sy(v){ return pad.t + H - ((v + yMax) / (2*yMax)) * H; }
    function sxCenter(i){ return pad.l + (i + 0.5) * (W/years); }

    var ticks = 5;
    for (var t=0; t<=ticks; t++){
      var v = yMax * t / ticks;
      [ v, -v ].forEach(function(yv, idx){
        var y = sy(yv);
        var gl = document.createElementNS('http://www.w3.org/2000/svg','line');
        gl.setAttribute('x1', pad.l); gl.setAttribute('x2', pad.l + W);
        gl.setAttribute('y1', y);     gl.setAttribute('y2', y);
        gl.setAttribute('stroke', idx===0 ? '#233040' : '#1c2836');
        gl.setAttribute('stroke-width', '1');
        svg.appendChild(gl);

        if (t>0 || idx===0){
          var ty = document.createElementNS('http://www.w3.org/2000/svg','text');
          ty.setAttribute('x', pad.l - 8); ty.setAttribute('y', y + 4);
          ty.setAttribute('text-anchor','end'); ty.setAttribute('fill','#97a6ba');
          ty.setAttribute('font-size','11');
          ty.textContent = EUR0.format(yv);
          svg.appendChild(ty);
        }
      });
    }
    var y0 = sy(0);
    var zero = document.createElementNS('http://www.w3.org/2000/svg','line');
    zero.setAttribute('x1', pad.l); zero.setAttribute('x2', pad.l + W);
    zero.setAttribute('y1', y0);    zero.setAttribute('y2', y0);
    zero.setAttribute('stroke', '#2b3a4e'); zero.setAttribute('stroke-width', '1.5');
    svg.appendChild(zero);

    var band = W / years;
    var barW = band * 0.65;
    var frontW = barW * 0.55;

    function drawBar(xCenter, value, width, fill){
      var yTop   = sy(Math.max(0, value));
      var yBottom= sy(Math.min(0, value));
      var rect   = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x', xCenter - width/2);
      rect.setAttribute('y', yTop);
      rect.setAttribute('width', width);
      rect.setAttribute('height', Math.max(0, yBottom - yTop));
      rect.setAttribute('rx','6'); rect.setAttribute('ry','6');
      rect.setAttribute('fill', fill);
      return rect;
    }

    for (var i=0;i<years;i++){
      var cx = sxCenter(i);
      svg.appendChild( drawBar(cx, baseVals[i], barW, '#d35b66') );
      svg.appendChild( drawBar(cx, withPVVals[i], frontW, '#30d158') );

      var lr = document.createElementNS('http://www.w3.org/2000/svg','text');
      lr.textContent = EUR0.format(baseVals[i]).replace(/\\s?‚Ç¨/,'‚Ç¨');
      lr.setAttribute('x', cx);
      lr.setAttribute('y', sy(baseVals[i]) - 6);
      lr.setAttribute('text-anchor','middle');
      lr.setAttribute('fill','#cfe1f1');
      lr.setAttribute('font-size','12');
      lr.setAttribute('style','paint-order:stroke;stroke:#0b0f14;stroke-width:2px');
      svg.appendChild(lr);

      var lv = document.createElementNS('http://www.w3.org/2000/svg','text');
      lv.textContent = EUR0.format(withPVVals[i]).replace(/\\s?‚Ç¨/,'‚Ç¨');
      lv.setAttribute('x', cx);
      lv.setAttribute('text-anchor','middle');
      lv.setAttribute('fill','#e6ffe8');
      lv.setAttribute('font-size','12');
      lv.setAttribute('style','paint-order:stroke;stroke:#0b0f14;stroke-width:2px');
      var yv = withPVVals[i] >= 0 ? (sy(withPVVals[i]) - 6) : (sy(withPVVals[i]) + 16);
      lv.setAttribute('y', yv);
      svg.appendChild(lv);

      var tx = document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.textContent = String(startYear + i);
      tx.setAttribute('x', cx);
      tx.setAttribute('y', pad.t + H + 16);
      tx.setAttribute('text-anchor','middle');
      tx.setAttribute('fill','#97a6ba');
      tx.setAttribute('font-size','11');
      tx.setAttribute('transform', 'rotate(-28 '+cx+' '+(pad.t+H+16)+')');
      svg.appendChild(tx);
    }

    var lx = pad.l, ly = pad.t - 10;
    function legendBox(x, y, color, txt){
      var b = document.createElementNS('http://www.w3.org/2000/svg','rect');
      b.setAttribute('x', x); b.setAttribute('y', y-9);
      b.setAttribute('width','14'); b.setAttribute('height','14'); b.setAttribute('rx','3');
      b.setAttribute('fill', color); svg.appendChild(b);
      var t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x', x+20); t.setAttribute('y', y+2);
      t.setAttribute('fill','#cfe1f1'); t.setAttribute('font-size','12'); t.textContent = txt;
      svg.appendChild(t);
    }
    legendBox(lx, ly, '#d35b66', 'Facture sans PV');
    legendBox(lx + 160, ly, '#30d158', 'Facture avec PV');
  }
// Wrappers pour l‚Äôonglet Batterie (r√©utilisent la logique existante)
function renderBillsGrowthChartB(p){
  // m√™me calcul que renderBillsGrowthChart, mais cible les √©l√©ments de l‚Äôonglet 3
  var svg = document.getElementById('billChartB');
  if(!svg) return;

  var incSpan = document.getElementById('billIncPctB');
  if (incSpan) incSpan.textContent = ((p.inc||0)*100).toFixed(1).replace(/\.0$/,'') + ' %/an';

  // On r√©utilise la logique d‚Äôorigine en recopiant la partie ‚Äúdessin‚Äù
  // -> on injecte une version locale minimaliste bas√©e sur l‚Äôoriginale :
  var w = svg.clientWidth || svg.getBoundingClientRect().width || 900;
  var h = Number(svg.getAttribute('height')) || 320;
  var pad = {l:64, r:16, t:28, b:58};

  svg.setAttribute('viewBox','0 0 '+w+' '+h);
  while (svg.firstChild) svg.removeChild(svg.firstChild);

  var base = computeAnnualBillBase(p);
  var years = 20, inc = p.inc||0;
  var startYear = (new Date()).getFullYear();

  var vals = [], max = 0, labels = [];
  for (var i=0;i<years;i++){
    var v = base * Math.pow(1+inc, i);
    vals.push(v); if (v>max) max=v;
    labels.push(String(startYear + i));
  }

  if (!(max > 0)){
    var txt=document.createElementNS('http://www.w3.org/2000/svg','text');
    txt.setAttribute('x',16); txt.setAttribute('y',28); txt.setAttribute('fill','#97a6ba');
    txt.textContent='Renseignez tarifs et consommations pour calculer la facture.';
    svg.appendChild(txt); return;
  }

  var stepY = Math.pow(10, Math.max(2, String(Math.floor(max)).length - 2));
  var niceMax = Math.ceil(max / stepY) * stepY;

  var W = w - pad.l - pad.r, H = h - pad.t - pad.b;
  var band = W / years;
  var barW = band * 0.65;

  function sx(i){ return pad.l + i*band + (band - barW)/2; }
  function sy(v){ return pad.t + H - (v / niceMax) * H; }

  var ticks = 5;
  for (var t=0; t<=ticks; t++){
    var yv = niceMax * t / ticks, y = sy(yv);
    var gl = document.createElementNS('http://www.w3.org/2000/svg','line');
    gl.setAttribute('x1', pad.l); gl.setAttribute('x2', pad.l + W);
    gl.setAttribute('y1', y);     gl.setAttribute('y2', y);
    gl.setAttribute('stroke', '#233040'); gl.setAttribute('stroke-width','1');
    svg.appendChild(gl);

    var gy = document.createElementNS('http://www.w3.org/2000/svg','text');
    gy.setAttribute('x', pad.l - 8); gy.setAttribute('y', y + 4);
    gy.setAttribute('text-anchor','end'); gy.setAttribute('fill','#97a6ba');
    gy.setAttribute('font-size','11');
    gy.textContent = EUR0.format(yv);
    svg.appendChild(gy);
  }

  for (var i=0;i<years;i++){
    var v = vals[i];
    var x = sx(i), y = sy(v), bh = pad.t + H - y;

    var rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', x); rect.setAttribute('y', y);
    rect.setAttribute('width', barW); rect.setAttribute('height', Math.max(0,bh));
    rect.setAttribute('rx','6'); rect.setAttribute('ry','6');
    rect.setAttribute('fill', '#d35b66');
    svg.appendChild(rect);

    var lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
    lbl.textContent = EUR0.format(v).replace(/\s?‚Ç¨/, '‚Ç¨');
    lbl.setAttribute('text-anchor','middle');
    lbl.setAttribute('font-size','12');
    lbl.setAttribute('x', x + barW/2);
    lbl.setAttribute('y', y - 6);
    lbl.setAttribute('fill', '#cfe1f1');
    lbl.setAttribute('style','paint-order:stroke;stroke:#0b0f14;stroke-width:2px');
    svg.appendChild(lbl);

    var tx = document.createElementNS('http://www.w3.org/2000/svg','text');
    tx.textContent = String(startYear + i);
    tx.setAttribute('x', x + barW/2);
    tx.setAttribute('y', pad.t + H + 16);
    tx.setAttribute('text-anchor','middle');
    tx.setAttribute('fill','#97a6ba');
    tx.setAttribute('font-size','11');
    tx.setAttribute('transform','rotate(-28 '+(x+barW/2)+' '+(pad.t+H+16)+')');
    svg.appendChild(tx);
  }

  var ytitle = document.createElementNS('http://www.w3.org/2000/svg','text');
  ytitle.setAttribute('x', pad.l);
  ytitle.setAttribute('y', pad.t - 8);
  ytitle.setAttribute('fill','#9bb0c6');
  ytitle.setAttribute('font-size','12');
  ytitle.textContent = 'Montant annuel estim√© (‚Ç¨)';
  svg.appendChild(ytitle);
}

function renderBillsCompareChartB(p, r){
  // copie quasi-identique de renderBillsCompareChart mais vers #billCompareChartB
  var svg = document.getElementById('billCompareChartB');
  if(!svg) return;
  var w = svg.clientWidth || svg.getBoundingClientRect().width || 900;
  var h = Number(svg.getAttribute('height')) || 360;
  var pad = {l:64, r:16, t:28, b:58};
  svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
  while (svg.firstChild) svg.removeChild(svg.firstChild);

  var years = 20;
  var inc   = p.inc || 0;
  var base1 = computeAnnualBillBase(p);
  var startYear = (new Date()).getFullYear();
  var prime = Number(document.getElementById('prime').value) || 0;

  var baseVals = [], withPVVals = [];
  var maxPos = 0, minNeg = 0;

  for (var i=0;i<years;i++){
    var baseY = base1 * Math.pow(1+inc, i);
    var econY = (r && r.yearly && r.yearly[i]) ? r.yearly[i].e : 0;
    var withPV = baseY - (econY + (i===1 ? prime : 0));
    baseVals.push(baseY);
    withPVVals.push(withPV);
    if (baseY > maxPos) maxPos = baseY;
    if (withPV < minNeg) minNeg = withPV;
  }

  var maxAbs = Math.max(maxPos, Math.abs(minNeg), 1);
  function niceCeil(v){
    var p = Math.pow(10, Math.max(2, Math.floor(Math.log10(v)) - 1));
    return Math.ceil(v/p)*p;
  }
  var yMax = niceCeil(maxAbs);

  var W = w - pad.l - pad.r, H = h - pad.t - pad.b;
  function sy(v){ return pad.t + H - ((v + yMax) / (2*yMax)) * H; }
  function sxCenter(i){ return pad.l + (i + 0.5) * (W/years); }

  var ticks = 5;
  for (var t=0; t<=ticks; t++){
    var v = yMax * t / ticks;
    [ v, -v ].forEach(function(yv, idx){
      var y = sy(yv);
      var gl = document.createElementNS('http://www.w3.org/2000/svg','line');
      gl.setAttribute('x1', pad.l); gl.setAttribute('x2', pad.l + W);
      gl.setAttribute('y1', y);     gl.setAttribute('y2', y);
      gl.setAttribute('stroke', idx===0 ? '#233040' : '#1c2836');
      gl.setAttribute('stroke-width', '1');
      svg.appendChild(gl);

      if (t>0 || idx===0){
        var ty = document.createElementNS('http://www.w3.org/2000/svg','text');
        ty.setAttribute('x', pad.l - 8); ty.setAttribute('y', y + 4);
        ty.setAttribute('text-anchor','end'); ty.setAttribute('fill','#97a6ba');
        ty.setAttribute('font-size','11');
        ty.textContent = EUR0.format(yv);
        svg.appendChild(ty);
      }
    });
  }
  var y0 = sy(0);
  var zero = document.createElementNS('http://www.w3.org/2000/svg','line');
  zero.setAttribute('x1', pad.l); zero.setAttribute('x2', pad.l + W);
  zero.setAttribute('y1', y0);    zero.setAttribute('y2', y0);
  zero.setAttribute('stroke', '#2b3a4e'); zero.setAttribute('stroke-width', '1.5');
  svg.appendChild(zero);

  var band = W / years;
  var barW = band * 0.65;
  var frontW = barW * 0.55;

  function drawBar(xCenter, value, width, fill){
    var yTop   = sy(Math.max(0, value));
    var yBottom= sy(Math.min(0, value));
    var rect   = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', xCenter - width/2);
    rect.setAttribute('y', yTop);
    rect.setAttribute('width', width);
    rect.setAttribute('height', Math.max(0, yBottom - yTop));
    rect.setAttribute('rx','6'); rect.setAttribute('ry','6');
    rect.setAttribute('fill', fill);
    return rect;
  }

  for (var i=0;i<years;i++){
    var cx = sxCenter(i);
    svg.appendChild( drawBar(cx, baseVals[i], barW, '#d35b66') );
    svg.appendChild( drawBar(cx, withPVVals[i], frontW, '#30d158') );

    var lr = document.createElementNS('http://www.w3.org/2000/svg','text');
    lr.textContent = EUR0.format(baseVals[i]).replace(/\s?‚Ç¨/,'‚Ç¨');
    lr.setAttribute('x', cx);
    lr.setAttribute('y', sy(baseVals[i]) - 6);
    lr.setAttribute('text-anchor','middle');
    lr.setAttribute('fill','#cfe1f1');
    lr.setAttribute('font-size','12');
    lr.setAttribute('style','paint-order:stroke;stroke:#0b0f14;stroke-width:2px');
    svg.appendChild(lr);

    var lv = document.createElementNS('http://www.w3.org/2000/svg','text');
    lv.textContent = EUR0.format(withPVVals[i]).replace(/\s?‚Ç¨/,'‚Ç¨');
    lv.setAttribute('x', cx);
    lv.setAttribute('text-anchor','middle');
    lv.setAttribute('fill','#e6ffe8');
    lv.setAttribute('font-size','12');
    lv.setAttribute('style','paint-order:stroke;stroke:#0b0f14;stroke-width:2px');
    var yv = withPVVals[i] >= 0 ? (sy(withPVVals[i]) - 6) : (sy(withPVVals[i]) + 16);
    lv.setAttribute('y', yv);
    svg.appendChild(lv);

    var tx = document.createElementNS('http://www.w3.org/2000/svg','text');
    tx.textContent = String(startYear + i);
    tx.setAttribute('x', cx);
    tx.setAttribute('y', pad.t + H + 16);
    tx.setAttribute('text-anchor','middle');
    tx.setAttribute('fill','#97a6ba');
    tx.setAttribute('font-size','11');
    tx.setAttribute('transform', 'rotate(-28 '+cx+' '+(pad.t+H+16)+')');
    svg.appendChild(tx);
  }

  var lx = pad.l, ly = pad.t - 10;
  function legendBox(x, y, color, txt){
    var b = document.createElementNS('http://www.w3.org/2000/svg','rect');
    b.setAttribute('x', x); b.setAttribute('y', y-9);
    b.setAttribute('width','14'); b.setAttribute('height','14'); b.setAttribute('rx','3');
    b.setAttribute('fill', color); svg.appendChild(b);
    var t = document.createElementNS('http://www.w3.org/200/svg','text'); // typo corrig√©e ci-dessous
  }
  // petit correctif : le namespace ci-dessus contient une coquille, on ajoute la vraie l√©gende :
  (function(){
    function legend(x, color, label){
      var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
      r.setAttribute('x', x); r.setAttribute('y', pad.t - 19);
      r.setAttribute('width','14'); r.setAttribute('height','14'); r.setAttribute('rx','3');
      r.setAttribute('fill', color); svg.appendChild(r);
      var t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x', x+20); t.setAttribute('y', pad.t - 8);
      t.setAttribute('fill','#cfe1f1'); t.setAttribute('font-size','12'); t.textContent = label;
      svg.appendChild(t);
    }
    legend(pad.l, '#d35b66', 'Facture sans PV');
    legend(pad.l+160, '#30d158', 'Facture avec PV (batt)');
  })();
}

  /* ===== RENDUS BATTERIE ===== */
  function renderMonthB(p, r){
    const tb=document.querySelector('#monthTblB tbody'); if(!tb) return;
    tb.innerHTML='';
    const priceHP=(Number(document.getElementById('buyHP').value)||Number(document.getElementById('buy').value)||0);
    const priceHC=(Number(document.getElementById('buyHC').value)||Number(document.getElementById('buy').value)||0);
    const sell=Number(document.getElementById('sell').value)||0;

    let totalEtot=0;
    for(let i=0;i<12;i++){
      const cons=r.TOT[i], prod=r.P[i];
      const econK = (r.selfHP[i]||0) + (r.coverHC[i]||0);
      const revK  = r.sellK[i]||0;
      const buyK  = (r.buyHPk[i]||0) + (r.buyHCk[i]||0);
      const euroSave=(r.selfHP[i]||0)*priceHP + (r.coverHC[i]||0)*priceHC;
      const euroSell=(revK)*sell;
      const euroTot=euroSave+euroSell; totalEtot+=euroTot;

      const tr=document.createElement('tr');
      tr.innerHTML =
        '<td>'+MONTHS[i]+'</td>'+
        '<td>'+FR0.format(cons)+' kWh</td>'+
        '<td>'+FR0.format(prod)+' kWh</td>'+
        '<td>'+FR0.format(econK)+' kWh</td>'+
        '<td>'+FR0.format(revK)+' kWh</td>'+
        '<td>'+FR0.format(buyK)+' kWh</td>'+
        '<td>'+EUR2.format(euroSave)+'</td>'+
        '<td>'+EUR2.format(euroSell)+'</td>'+
        '<td>'+EUR2.format(euroTot)+'</td>';
      tb.appendChild(tr);
    }
    document.getElementById('t_C_B').textContent   = FR0.format(r.Csum)+' kWh';
    document.getElementById('t_P_B').textContent   = FR0.format(r.Psum)+' kWh';
    document.getElementById('t_Ekwh_B').textContent= FR0.format(r.selfHPSum)+' kWh';
    document.getElementById('t_Rkwh_B').textContent= FR0.format(r.surplusSum)+' kWh';
    document.getElementById('t_Buy_B').textContent = FR0.format(r.gridSum)+' kWh';
    document.getElementById('t_Save_B').textContent= EUR2.format(r.econ1);
    document.getElementById('t_Sell_B').textContent= EUR2.format(r.sell1);
    document.getElementById('t_Etot_B').textContent= EUR2.format(totalEtot);
  }
function renderYearTableB(yearly){
  const tb = document.querySelector('#yearTblB tbody'); if(!tb) return;
  tb.innerHTML = '';

  const primeVal = Math.max(0, Number(document.getElementById('prime').value) || 0);

  let cum = 0;
  for (let i = 0; i < yearly.length; i++) {
    const addPrime  = (i === 1) ? primeVal : 0;           // ann√©e 2
    const eThisYear = yearly[i].e + addPrime;
    cum += eThisYear;

    let label = EUR2.format(eThisYear);
    if (addPrime > 0) {
      label += ' <span class="small" style="color:#9bb0c6">dont ' + EUR0.format(primeVal) + ' de prime</span>';
    }

    const tr = document.createElement('tr');
    tr.innerHTML =
      '<td>' + yearly[i].year + '</td>' +
      '<td>' + label + '</td>' +
      '<td>' + EUR2.format(cum) + '</td>';
    tb.appendChild(tr);
  }
}

  function renderKPIsB(p, r){
    document.getElementById('k_autB').textContent=(r.aut*100).toFixed(1)+' %';
    document.getElementById('k_scB').textContent=(r.sc*100).toFixed(1)+' %';
    document.getElementById('k_revB').textContent=(r.revPct*100).toFixed(1)+' %';

    document.getElementById('k_yearsB_A').textContent=p.years;
    document.getElementById('k_yearsB_B').textContent=p.years;
    document.getElementById('k_yearsB_C').textContent=p.years;

    document.getElementById('k_totAllB').textContent = EUR0.format(r.totAll);
    document.getElementById('k_totSaveB').textContent = EUR0.format(r.totSave);
    document.getElementById('k_totSellB').textContent = EUR0.format(r.totSell);

    const avgMonthly = (p.years>0) ? (r.totAll/(p.years*12)) : 0;
    document.getElementById('k_avgMonthlyB').textContent = EUR2.format(avgMonthly);

    document.getElementById('k_capexB').textContent   = EUR0.format(r.capexTot);
    document.getElementById('k_primeB').textContent   = EUR0.format((Number(document.getElementById('prime').value)||0));
    document.getElementById('k_costrealB').textContent= EUR0.format(r.costReal);
    document.getElementById('k_roiB').textContent     = r.payback+' ans';
  }
  function renderChartB(p, pmaxInfo, B_kWh){
    const svg=document.getElementById('chartB'); if(!svg) return;
    const w=svg.clientWidth||svg.getBoundingClientRect().width||900;
    const h=Number(svg.getAttribute('height'))||280;
    const pad={l:42,r:12,t:10,b:26};
    svg.setAttribute('viewBox','0 0 '+w+' '+h);
    while(svg.firstChild) svg.removeChild(svg.firstChild);

    const pmax=(pmaxInfo&&isFinite(pmaxInfo.pmax))?pmaxInfo.pmax:NaN;
    const crossOutEl=document.getElementById('crossOutB');
    if(crossOutEl) crossOutEl.value='‚Äî';

    if(!isFinite(pmax)||pmax<1){
      const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x',16);txt.setAttribute('y',24);txt.setAttribute('fill','#97a6ba');
      txt.textContent='Renseigne Surface & Puissance module pour calculer Pmax (graphique : 1 ‚Üí Pmax).';
      svg.appendChild(txt); return;
    }

    const points=[]; let step;
    if(pmax<=50) step=1; else if(pmax<=120) step=2; else step=Math.ceil(pmax/60);
    for(let x=1;x<=pmax+1e-9;x+=step){
      const r=computeBattAll({ ...p, pwr:x }, B_kWh, Number(document.getElementById('battPrice').value||400));
      points.push({x:x, aut:r.aut*100, sc:r.sc*100, rev:r.revPct*100});
    }

    let crossP=NaN;
for(let i=1;i<points.length;i++){
  const d0=points[i-1].aut-points[i-1].sc, d1=points[i].aut-points[i].sc;
  if((d0<=0&&d1>=0)||(d0>=0&&d1<=0)){
    const t=(0-d0)/(d1-d0);
    crossP = points[i-1].x + (points[i].x-points[i-1].x)*t;
    break;
  }
}
let pick = (isFinite(crossP) ? Math.round(crossP) : NaN);
if (isFinite(pick)) pick = Math.max(1, Math.min(pick, Math.round(pmax)));

const pwrBEl = document.getElementById('pwrB');

// ‚ûú ne pas √©craser la puissance quand un kit est actif/verrouill√©
var lockKitEl = document.getElementById('lockKit');
var kitLocked = (lockKitEl && lockKitEl.checked) || (typeof KIT_MODE!=='undefined' && KIT_MODE);

// Affiche le croisement mais en mode kit on montre ¬´ ‚Äî (kit) ¬ª
if (crossOutEl) crossOutEl.value = kitLocked ? '‚Äî (kit)' : (isFinite(pick) ? String(pick) : '‚Äî');

// Si PAS de kit, on peut encore auto-appliquer le croisement
if (USE_CROSS_AS_PWR_B && !userPwrOverrideB && !kitLocked && isFinite(pick) && pwrBEl) {
  const cur = Math.max(1, Math.round(Number(pwrBEl.value)||0));
  if (cur !== pick) {
    pwrBEl.value = String(pick);
    applyAutoTarifEtPrime(pick);
    scheduleRun();
  }
}


    const maxX=pmax, maxY=100, minY=0;
    const W=w-pad.l-pad.r, H=h-pad.t-pad.b;
    const sx=x=>pad.l+(x-1)*(W/(maxX-1));
    const sy=y=>pad.t+H-((y-minY)/(maxY-minY))*H;

    for(let gy=0;gy<=5;gy++){
      const yv=gy*20, y=sy(yv);
      const line=document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1',pad.l); line.setAttribute('x2',pad.l+W);
      line.setAttribute('y1',y); line.setAttribute('y2',y);
      line.setAttribute('stroke','#233040'); line.setAttribute('stroke-width','1'); svg.appendChild(line);
      const lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x',6); lbl.setAttribute('y',y+4); lbl.setAttribute('fill','#97a6ba'); lbl.setAttribute('font-size','10');
      lbl.textContent=yv+'%'; svg.appendChild(lbl);
    }
    const nXTicks=6;
    for(let gx=0;gx<nXTicks;gx++){
      const xv=1+gx*(maxX-1)/(nXTicks-1), lx=sx(xv), ly=pad.t+H+14;
      const tx=document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.setAttribute('x',lx); tx.setAttribute('y',ly); tx.setAttribute('text-anchor','middle');
      tx.setAttribute('fill','#97a6ba'); tx.setAttribute('font-size','10');
      tx.textContent=xv.toFixed(0)+' kWc'; svg.appendChild(tx);
    }
    function makePath(arr,key){let d='';for(let j=0;j<arr.length;j++){const px=sx(arr[j].x),py=sy(arr[j][key]);d+=(j===0?'M':' L')+px+' '+py;}return d;}
    const pathAut=document.createElementNS('http://www.w3.org/2000/svg','path'); pathAut.setAttribute('d',makePath(points,'aut')); pathAut.setAttribute('fill','none'); pathAut.setAttribute('stroke','#3da5ff'); pathAut.setAttribute('stroke-width','2'); svg.appendChild(pathAut);
    const pathSc=document.createElementNS('http://www.w3.org/2000/svg','path'); pathSc.setAttribute('d',makePath(points,'sc')); pathSc.setAttribute('fill','none'); pathSc.setAttribute('stroke','#30d158'); pathSc.setAttribute('stroke-width','2'); svg.appendChild(pathSc);
    const pathRev=document.createElementNS('http://www.w3.org/2000/svg','path'); pathRev.setAttribute('d',makePath(points,'rev')); pathRev.setAttribute('fill','none'); pathRev.setAttribute('stroke','#ffb020'); pathRev.setAttribute('stroke-width','2'); svg.appendChild(pathRev);

    if (crossOutEl && !crossOutEl._dbl) {
      crossOutEl._dbl = true;
      crossOutEl.addEventListener('dblclick', function(){
        userPwrOverrideB = false;
        scheduleRun();
      });
    }
  }

  /* ===== Tests ===== */
  function addTestRow(name,exp,got,ok){var tr=document.createElement('tr'); tr.innerHTML='<td>'+name+'</td><td>'+exp+'</td><td>'+got+'</td><td>'+(ok?'<span class="badge">OK</span>':'<span style="color:#ffb4b4">KO</span>')+'</td>'; document.querySelector('#testsTbl tbody').appendChild(tr);}
  function runTests(){
    var body=document.querySelector('#testsTbl tbody'); if(body) body.innerHTML='';
    var R=readRows();
    addTestRow('12 mois saisis','12',String(R.HP.length), R.HP.length===12 && R.HC.length===12);
    addTestRow('Sommes coh√©rentes','HP+HC‚âàTOT', FR0.format(sum(R.HP)+sum(R.HC))+' vs '+FR0.format(sum(R.TOT)),
      Math.abs((sum(R.HP)+sum(R.HC))-sum(R.TOT))<=1);

    var testP=computePmax(100,500);
    addTestRow('Pmax(100 m¬≤, 500 Wc)','25.00 kWc',testP.pmax.toFixed(2)+' kWc', Math.abs(testP.pmax-25)<1e-6);

    if (mode==='A') {
      var buyHP=Number(document.getElementById('buyHP').value)||0;
      var buyHC=Number(document.getElementById('buyHC').value)||0;
      var expected = sum(R.HP)*buyHP + sum(R.HC)*buyHC;
      var got = sum(R.BILL);
      addTestRow('Facture Mode A = HP√ótarifHP + HC√ótarifHC', EUR2.format(expected), EUR2.format(got), Math.abs(expected - got) < 0.5);
    }
  }
  function addTestRowB(name,exp,got,ok){var tr=document.createElement('tr'); tr.innerHTML='<td>'+name+'</td><td>'+exp+'</td><td>'+got+'</td><td>'+(ok?'<span class="badge">OK</span>':'<span style="color:#ffb4b4">KO</span>')+'</td>'; document.querySelector('#testsTblB tbody').appendChild(tr);}
  function runTestsB(){
    var body=document.querySelector('#testsTblB tbody'); if(body) body.innerHTML='';
    var R=readRows();
    addTestRowB('12 mois saisis','12',String(R.HP.length), R.HP.length===12 && R.HC.length===12);
    var testP=computePmax(100,500);
    addTestRowB('Pmax(100 m¬≤, 500 Wc)','25.00 kWc',testP.pmax.toFixed(2)+' kWc', Math.abs(testP.pmax-25)<1e-6);
  }

  /* ========= Pipeline ========= */
  function run(){
  var tab3Active = document.getElementById('tab3').classList.contains('active');
  var pwrForTariff = tab3Active ? (Number(document.getElementById('pwrB')?.value)||0) : (Number(document.getElementById('pwr')?.value)||0);
  applyAutoTarifEtPrime(pwrForTariff);

  recalcByMode();
  var p = readInputsAll();
  p.kit = getSelectedKit();   // <<<--- AJOUT

  var r = compute(p);
  renderMonth(p,r); renderYearTable(r.yearly); renderKPIs(p,r);
  document.getElementById('results').hidden=false;
  renderChart(p, window.gPmaxInfo || {pmax:NaN,modules:0});
  renderBillsGrowthChart(p);
  renderBillsCompareChart(p, r);
  runTests();

  if (tab3Active) {
    try { runBatt(); } catch(e){ console.error(e); }
  }
}

function runBatt(){
  const p = readInputsAll();
  p.kit = getSelectedKit();   // <<<--- AJOUT

  p.pwr = Number(document.getElementById('pwrB')?.value || 0);
  const B_kWh   = Number(document.getElementById('battKWh')?.value || 0);
  const B_price = Number(document.getElementById('battPrice')?.value || 400);

  const r = computeBattAll(p, B_kWh, B_price);
  document.getElementById('resultsB').hidden=false;
  renderMonthB(p, r);
  renderYearTableB(r.yearly);
  renderKPIsB(p, r);
  renderChartB(p, window.gPmaxInfo || {pmax:NaN,modules:0}, B_kWh);
  runTestsB();
}


  /* debounce */
  var _rt=null; function scheduleRun(){ if(_rt) clearTimeout(_rt); _rt=setTimeout(run,80); }

  /* events tableau */
  document.getElementById('inputsTbl').addEventListener('input',function(e){
    var row=e.target.closest('tr'); if(!row) return;
    if(mode==='A'){
      if(e.target.getAttribute('data-k')==='HP' || e.target.getAttribute('data-k')==='HC'){
        var hp=Number(row.querySelector('input[data-k="HP"]').value)||0;
        var hc=Number(row.querySelector('input[data-k="HC"]').value)||0;
        row.querySelector('input[data-k="TOT"]').value=hp+hc;
        row.querySelector('.src').textContent='HP/HC saisis';
      }
    }else if(mode==='B'){
      if(e.target.getAttribute('data-k')==='TOT'){
        var r=pctToRatio(document.getElementById('ratio').value);
        var tot=Number(row.querySelector('input[data-k="TOT"]').value)||0;
        var hp=Math.round(tot*r), hc=tot-hp;
        row.querySelector('input[data-k="HP"]').value=hp;
        row.querySelector('input[data-k="HC"]').value=hc;
        row.querySelector('.src').textContent='Ventil√© ratio';
      }
    }
    writeSums(); scheduleRun();
  });

  /* radios */
  document.querySelectorAll('input[name="mode"]').forEach(function(r){ r.addEventListener('change',function(){ setMode(this.value); }); });
  document.querySelectorAll('input[name="cBillMode"]').forEach(function(r){ r.addEventListener('change',function(){ setMode('C'); }); });
// --- S√©lecteur de kit pr√©-d√©fini ---


  /* inputs globaux */
  ['buy','buyHP','buyHC','sell','inc','years','ratio','avgBill','battKWh','battPrice'].forEach(function(id){
    var el=document.getElementById(id); 
    if(el) el.addEventListener('input',function(){
      if(id==='sell') userSellOverride = true;
      updateAlerts(); 
      scheduleRun();
    });
  });

  // radios des tarifs installation
  document.querySelectorAll('input[name="capexTariff"]').forEach(function(r){
    r.addEventListener('change', function(){ scheduleRun(); });
  });

  var primeElUser = document.getElementById('prime');
  if(primeElUser){
    primeElUser.addEventListener('input', function(){ userPrimeOverride = true; scheduleRun(); });
  }

  /* pwr override (onglet 2) */
  var pwrEl=document.getElementById('pwr');
  if(pwrEl){
    pwrEl.addEventListener('input', function(){
      userPwrOverride=true;
      applyAutoTarifEtPrime(Number(this.value)||0);
      scheduleRun();
    });
    pwrEl.addEventListener('change', function(){
      var v=Math.max(1, Math.round(Number(this.value)||0));
      if(this.value!=String(v)) this.value=v;
      userPwrOverride=true;
      applyAutoTarifEtPrime(v);
      scheduleRun();
    });
  }

  /* pwrB override (onglet 3) */
  var pwrBEl=document.getElementById('pwrB');
  if(pwrBEl){
    pwrBEl.addEventListener('input', function(){
      userPwrOverrideB = true;
      applyAutoTarifEtPrime(Number(this.value)||0);
      scheduleRun();
    });
    pwrBEl.addEventListener('change', function(){
      var v=Math.max(1, Math.round(Number(this.value)||0));
      if(this.value!=String(v)) this.value=v;
      userPwrOverrideB = true;
      applyAutoTarifEtPrime(v);
      scheduleRun();
    });
  }

  /* sync Wp & Pmax */
  (function syncWP(){
    var wp=document.getElementById('wp'), wp2=document.getElementById('wp2'); if(!wp||!wp2) return;
    var lock=false;
    function updPmax(){
      window.gPmaxInfo=computePmax(Number(document.getElementById('roof').value)||0, Number(document.getElementById('wp').value)||0);
      var pmaxOut=document.getElementById('pmaxOut');
      if(pmaxOut){ pmaxOut.value=isFinite(window.gPmaxInfo.pmax)?window.gPmaxInfo.pmax.toFixed(2):'‚Äî'; }
      scheduleRun();
    }
    wp.addEventListener('input',function(){ if(lock) return; lock=true; wp2.value=wp.value; updPmax(); lock=false; });
    wp2.addEventListener('input',function(){ if(lock) return; lock=true; wp.value=wp2.value; updPmax(); lock=false; });
  })();
  function updatePmaxAuto(){
    window.gPmaxInfo=computePmax(Number(document.getElementById('roof').value)||0, Number(document.getElementById('wp').value)||0);
    var pmaxOut=document.getElementById('pmaxOut');
    if(pmaxOut){ pmaxOut.value=isFinite(window.gPmaxInfo.pmax)?window.gPmaxInfo.pmax.toFixed(2):'‚Äî'; }
    scheduleRun();
  }
  document.getElementById('roof').addEventListener('input',updatePmaxAuto);
  document.getElementById('wp').addEventListener('input',updatePmaxAuto);

  /* redraw on resize */
  window.addEventListener('resize', function(){
    if (document.getElementById('tab2').classList.contains('active')) { scheduleRun(); }
    if (document.getElementById('tab3').classList.contains('active')) { scheduleRun(); }
  });

// La fonction principale pour remplir et t√©l√©charger le PDF
async function remplirEtTelechargerRapportPDF() {
    // 1. R√©cup√©ration des donn√©es dynamiques depuis votre HTML
    // Assurez-vous que ces IDs correspondent √† vos champs d'entr√©e actuels.
    const clientname = document.getElementById('clientnameClient') ? document.getElementById('clientnameClient').value : 'clientname du Client (Non trouv√©)';
    const address = document.getElementById('addressProjet') ? document.getElementById('addressProjet').value : 'address du Projet (Non trouv√©e)';

    // 2. D√©finition de l'emplacement du PDF
    // Remplacez cette URL par l'acc√®s direct √† votre PDF sur GitHub (ex: lien "Raw" ou GitHub Pages)
    const formUrl = 'rapport.pdf'; // Modifiez si le PDF est dans un autre dossier ou sur une URL compl√®te

    try {
        // 3. Chargement du PDF
        const existingPdfBytes = await fetch(formUrl).then(res => res.arrayBuffer());
        const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);

        // 4. Acc√®s au formulaire
        const form = pdfDoc.getForm();

        // 5. Remplissage des champs
        // ATTENTION : 'clientname' et 'address' DOIVENT correspondre aux clientnames exacts des champs de votre formulaire PDF.
        const clientnameField = form.getTextField('clientname'); 
        const addressField = form.getTextField('address');

        if (clientnameField) {
            clientnameField.setText(clientname);
        } else {
            console.warn("Champ PDF 'clientname' non trouv√©.");
        }

        if (addressField) {
            addressField.setText(address);
        } else {
            console.warn("Champ PDF 'address' non trouv√©.");
        }

        // 6. Sauvegarde et t√©l√©chargement
        const pdfBytes = await pdfDoc.save();
        
        // Cr√©er un blob pour le t√©l√©chargement
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'Rapport_Final_' + clientname.replace(/\s/g, '_') + '.pdf';
        document.body.appendChild(link);
        link.click(); // D√©clenche le t√©l√©chargement
        document.body.removeChild(link);
        
    } catch (error) {
        console.error("Erreur lors du remplissage du PDF:", error);
        alert("Impossible de g√©n√©rer le PDF. V√©rifiez l'URL du formulaire et les clientnames des champs.");
    }
}


    
  /* --- Sauvegarde et chargement JSON --- */
  document.getElementById('saveData').addEventListener('click', function(){
    const data = {};
    const modeRadio = document.querySelector('input[name="mode"]:checked');
    data.mode = modeRadio ? modeRadio.value : 'A';
    const cBillRadio = document.querySelector('input[name="cBillMode"]:checked');
    data.cBillMode = cBillRadio ? cBillRadio.value : 'avg';
    data.avgBill = Number(document.getElementById('avgBill')?.value || 0);

    data.nom = document.getElementById('clientName')?.value || '';
    data.pwr = document.getElementById('pwr').value || '';
    data.userPwrOverride = !!userPwrOverride;

    // puissance onglet 3
    data.pwrB = document.getElementById('pwrB')?.value || '';
    data.userPwrOverrideB = !!userPwrOverrideB;

    const center = map.getCenter();
    data.mapCenter = { lat: center.lat, lng: center.lng, zoom: map.getZoom() };
    data.drawnShapes = drawnItems.toGeoJSON();

    data.address      = document.getElementById('address').value || '';
    data.lat          = document.getElementById('lat').value || '';
    data.lng          = document.getElementById('lng').value || '';
    data.azimut       = document.getElementById('azimut').value || '';
    data.tilt         = document.getElementById('tilt').value || '';
    data.area         = document.getElementById('area').value || '';
    data.productible  = document.getElementById('productible').value || '';
    data.roof         = document.getElementById('roof').value || '';
    data.wp           = document.getElementById('wp').value   || '';
    data.pmax         = document.getElementById('pmaxOut').value || '';
    data.cp           = document.getElementById('cp').value || '';
    data.territoire   = document.getElementById('territoire').value || '';

    const rows = readRows();
    data.consoHP   = rows.HP;
    data.consoHC   = rows.HC;
    data.consoTOT  = rows.TOT;
    data.consoBILL = rows.BILL;

    data.P1    = window.P1.slice();
    data.buy   = document.getElementById('buy').value;
    data.buyHP = document.getElementById('buyHP').value;
    data.buyHC = document.getElementById('buyHC').value;
    data.ratio = document.getElementById('ratio').value;
    data.inc   = document.getElementById('inc').value;
    data.years = document.getElementById('years').value;
    data.sell  = document.getElementById('sell').value;
    const capexRadio = document.querySelector('input[name="capexTariff"]:checked');
    data.capexTariff = capexRadio ? Number(capexRadio.value) : 2150;
    data.prime = document.getElementById('prime').value;

    // batterie
    data.battKWh = document.getElementById('battKWh')?.value || '';
    data.battPrice = document.getElementById('battPrice')?.value || '';

    let fileName = (data.nom || 'PV').replace(/\\s+/g,'_');
    fileName += '_' + (data.pwr || '0') + 'kWc.json';

    const jsonString = JSON.stringify(data, null, 2);
    const blob  = new Blob([jsonString], { type:'application/json' });
    const url   = URL.createObjectURL(blob);
    const link  = document.createElement('a');
    link.href   = url;
    link.download = fileName;
    link.click();
  });

  document.getElementById('loadButton').addEventListener('click', function(){
    document.getElementById('loadData').click();
  });

  document.getElementById('loadData').addEventListener('change', function(event){
    const file = event.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = function(e){
        const data = JSON.parse(e.target.result);

        if (data.mode) {
          const r = document.querySelector('input[name="mode"][value="'+data.mode+'"]');
          if (r) { r.checked = true; setMode(data.mode); }
        }
        if (data.cBillMode) {
          const rC = document.querySelector('input[name="cBillMode"][value="'+data.cBillMode+'"]');
          if (rC) rC.checked = true;
        }
        if (typeof data.avgBill !== 'undefined') {
          const avg = document.getElementById('avgBill');
          if (avg) avg.value = data.avgBill;
        }

        if (data.nom !== undefined) document.getElementById('clientName').value = data.nom;
        if (data.pwr !== undefined) document.getElementById('pwr').value = data.pwr;
        if (typeof data.userPwrOverride !== 'undefined') userPwrOverride = !!data.userPwrOverride;
        else if (data.pwr !== undefined) userPwrOverride = true;

        // pwrB
        if (data.pwrB !== undefined) document.getElementById('pwrB').value = data.pwrB;
        if (typeof data.userPwrOverrideB !== 'undefined') userPwrOverrideB = !!data.userPwrOverrideB;
        else if (data.pwrB !== undefined) userPwrOverrideB = true;

        if(data.mapCenter) map.setView([data.mapCenter.lat, data.mapCenter.lng], data.mapCenter.zoom);
        if(data.drawnShapes){
          drawnItems.clearLayers();
          L.geoJSON(data.drawnShapes).eachLayer(function(layer){ drawnItems.addLayer(layer); });
        }

        if (data.address !== undefined)     document.getElementById('address').value     = data.address;
        if (data.lat !== undefined)         document.getElementById('lat').value         = data.lat;
        if (data.lng !== undefined)         document.getElementById('lng').value         = data.lng;
        if (data.azimut !== undefined)      document.getElementById('azimut').value      = data.azimut;
        if (data.tilt !== undefined)        document.getElementById('tilt').value        = data.tilt;
        if (data.area !== undefined)        document.getElementById('area').value        = data.area;
        if (data.productible !== undefined) document.getElementById('productible').value = data.productible;
        if (data.cp !== undefined)          document.getElementById('cp').value          = data.cp;
        if (data.territoire !== undefined)  document.getElementById('territoire').value  = data.territoire;

        if (data.lat && data.lng && !isNaN(parseFloat(data.lat)) && !isNaN(parseFloat(data.lng))) {
          try {
            if (typeof marker !== 'undefined' && marker) { map.removeLayer(marker); }
            marker = L.marker([parseFloat(data.lat), parseFloat(data.lng)]).addTo(map);
          } catch(_){}
        }

        if (data.cp !== undefined)         currentPostcode  = String(data.cp);
        if (data.territoire !== undefined) currentTerritory = String(data.territoire);

        if(data.roof !== undefined) document.getElementById('roof').value    = data.roof;
        if(data.wp   !== undefined) document.getElementById('wp').value      = data.wp;
        if(data.pmax !== undefined) document.getElementById('pmaxOut').value = data.pmax;

        {
          const tbody = document.querySelector('#inputsTbl tbody');
          if (tbody.children.length !== 12) {
            buildRows(defaultsCTot, pctToRatio(document.getElementById('ratio').value));
          }
          const rowsHTML = document.querySelectorAll('#inputsTbl tbody tr');

          if (data.mode === 'A') {
            for (let i=0;i<12;i++){
              if (data.consoHP)   rowsHTML[i].querySelector('input[data-k="HP"]').value   = (data.consoHP[i]   ?? 0);
              if (data.consoHC)   rowsHTML[i].querySelector('input[data-k="HC"]').value   = (data.consoHC[i]   ?? 0);
              const hp = Number(rowsHTML[i].querySelector('input[data-k="HP"]').value)||0;
              const hc = Number(rowsHTML[i].querySelector('input[data-k="HC"]').value)||0;
              rowsHTML[i].querySelector('input[data-k="TOT"]').value  = hp + hc;
              if (data.consoBILL) rowsHTML[i].querySelector('input[data-k="BILL"]').value = (data.consoBILL[i] ?? 0);
            }
            writeSums();
          } else if (data.mode === 'B') {
            for (let i=0;i<12;i++){
              if (data.consoTOT)  rowsHTML[i].querySelector('input[data-k="TOT"]').value  = (data.consoTOT[i]  ?? 0);
              if (data.consoBILL) rowsHTML[i].querySelector('input[data-k="BILL"]').value = (data.consoBILL[i] ?? 0);
            }
            recalcByMode(); writeSums();
          } else if (data.mode === 'C') {
            if (data.cBillMode === 'monthly' && data.consoBILL) {
              for (let i=0;i<12;i++){
                rowsHTML[i].querySelector('input[data-k="BILL"]').value = (data.consoBILL[i] ?? 0);
              }
            }
            recalcByMode(); writeSums();
          } else {
            for (let i=0;i<12;i++){
              if (data.consoHP)   rowsHTML[i].querySelector('input[data-k="HP"]').value   = (data.consoHP[i]   ?? 0);
              if (data.consoHC)   rowsHTML[i].querySelector('input[data-k="HC"]').value   = (data.consoHC[i]   ?? 0);
              if (data.consoTOT)  rowsHTML[i].querySelector('input[data-k="TOT"]').value  = (data.consoTOT[i]  ?? 0);
              if (data.consoBILL) rowsHTML[i].querySelector('input[data-k="BILL"]').value = (data.consoBILL[i] ?? 0);
            }
            writeSums();
          }
        }

        if(Array.isArray(data.P1)){
          window.P1 = data.P1.slice();
          const monthly = data.P1.map((val,i)=>({ month:i+1, Em:val }));
          fillMonthlyTable(monthly);
        }

        if(data.buy   !== undefined) document.getElementById('buy').value   = data.buy;
        if(data.buyHP !== undefined) document.getElementById('buyHP').value = data.buyHP;
        if(data.buyHC !== undefined) document.getElementById('buyHC').value = data.buyHC;
        if(data.ratio !== undefined) document.getElementById('ratio').value = data.ratio;
        if(data.inc   !== undefined) document.getElementById('inc').value   = data.inc;
        if(data.years !== undefined) document.getElementById('years').value = data.years;
        if(data.sell  !== undefined) document.getElementById('sell').value  = data.sell;
        if (data.capexTariff !== undefined) {
          var r = document.querySelector('input[name="capexTariff"][value="'+data.capexTariff+'"]');
          if (r) r.checked = true;
        }
        if(data.prime !== undefined) document.getElementById('prime').value = data.prime;
        if(data.territoire !== undefined) document.getElementById('territoire').value = data.territoire;
        if(data.cp         !== undefined) document.getElementById('cp').value         = data.cp;

        updatePmaxAuto();
        applyAutoTarifEtPrime();
        scheduleRun();
      };
      reader.readAsText(file);
    }
  });

  /* init */
  buildRows(defaultsCTot, 0.7);
  setMode('A');
  updatePmaxAuto();
  reflectKitUI();
run();
 
  })();
  </script>
</body>
</html>

